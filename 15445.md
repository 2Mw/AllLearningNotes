# CMU15-445 æ•°æ®åº“ç³»ç»Ÿ

[TOC]

è¯¾ç¨‹é“¾æ¥ï¼šhttps://15445.courses.cs.cmu.edu/fall2019/

ä¹¦ç±é“¾æ¥ï¼šhttps://www.db-book.com/

## ä¸€. å…³ç³»æ¨¡å‹

[è®²ä¹‰](https://15445.courses.cs.cmu.edu/fall2019/notes/01-introduction.pdf)

å…³ç³»æ¨¡å¼ä¸»è¦åŒ…å«ä¸‰éƒ¨åˆ†ï¼š

1. ç»“æ„(structure)ï¼šå…³ç³»å’Œå†…å®¹çš„å®šä¹‰
2. å®Œæ•´æ€§çº¦æŸ(Integrity)ï¼šç¡®ä¿æ•°æ®åº“çš„å†…å®¹æ»¡è¶³çº¦æŸ
3. æ“ä½œ(manipulation)ï¼šå¯¹äºæ•°æ®çš„å¢åˆ æ”¹æŸ¥

ä¸»é”®(primary key)ï¼šèƒ½å”¯ä¸€æ ‡è¯†ä¸€æ¡è®°å½•çš„å±æ€§ç»„ã€‚

DML: Data Manipulation Languages æ•°æ®æ“ä½œè¯­è¨€

å…³ç³»ä»£æ•°ï¼š

![image-20221021113900829](15445.assets/image-20221021113900829.png)

## äºŒ. é«˜çº§ SQL

[è®²ä¹‰](https://15445.courses.cs.cmu.edu/fall2019/notes/02-advancedsql.pdf)

å¯¹äº DBMS æ¥è¯´ï¼Œç”¨æˆ·æ— éœ€å…³å¿ƒæŸ¥è¯¢æ•°æ®åº“çš„è®¡ç®—å¤æ‚åº¦ï¼Œåªéœ€è¦å…³æ³¨æ•°æ®åº“æœ€ç»ˆçš„æŸ¥è¯¢ç»“æœå³å¯ã€‚å› æ­¤ DBMS éœ€è¦è¯„ä¼°æ¯ä¸€æ¬¡æ‰§è¡Œæ•ˆç‡ã€‚

å› æ­¤å°±äº§ç”Ÿäº†æŸ¥è¯¢ä¼˜åŒ–å™¨(query optimizer)ï¼šå¯ä»¥é‡æ’æ“ä½œæŒ‡ä»¤å¹¶ä¸”äº§ç”ŸæŸ¥è¯¢è®¡åˆ’

DML: Data Manipulation Languageï¼Œæ¯”å¦‚å¢åˆ æ”¹æŸ¥è¯­å¥

DDL: Data Definition Languageï¼Œåˆ›å»ºæ•°æ®åº“å’Œè¡¨çš„è¯­å¥ 

DCL: Data Control Languageï¼Œè¿˜æœ‰å®‰å…¨æ€§æˆæƒè¯­å¥ï¼Œè§†å›¾ã€çº¦æŸç­‰

### 1. èšåˆå‡½æ•°

èšåˆå‡½æ•°æ¯”å¦‚ï¼šAVGï¼ŒMINï¼ŒMAXï¼ŒCOUNTï¼ŒSUMï¼ŒSTD

èšåˆå‡½æ•°æ”¯æŒ DISTINCT å…³é”®å­—ï¼š

```sql
SELECT COUNT(DISTINCT score) FROM student where id like '@cs';
```

åœ¨èšåˆè¯­å¥ä¸­ï¼Œæœªä½¿ç”¨èšåˆå‡½æ•°å­—æ®µåœ¨ where è¯­å¥ä¸­æœªå‡ºç°å°±ä¸èƒ½å† select è¯­å¥ä¸­å‡ºç°ï¼Œå¦åˆ™å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¼šæŠ¥é”™ã€‚æ¯”å¦‚ï¼š

```sql
SELECT AVG(s.gpa), e.cid FROM enrolled AS e, student AS s WHERE e.sid = s.sid;
```

è¿™é‡Œ `e.cid` çš„å‡ºç°åœ¨ select å­å¥ä¸­æ˜¯æä¸åˆç†çš„ï¼Œå› ä¸ºä¸€ä¸ªå¹³å‡æˆç»©æ‰€ç»Ÿè®¡çš„è¯¾ç¨‹ id æœ‰å¾ˆå¤šä¸ªï¼Œåœ¨è¿™é‡Œç»Ÿè®¡è¿™ä¸ªå­—æ®µæ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚

> åœ¨ PostgreSQL å’Œ MySQL 5.7 åŠä¹‹åçš„ç‰ˆæœ¬ä¼šæŠ¥é”™ï¼Œåœ¨ MySQL 5.7 å’Œ sqlite ä¸Šä¸ä¼šæŠ¥é”™ï¼Œä¼šéšæœºæŒ‘é€‰ä¸€ä¸ª e.cid ä½œä¸ºç»“æœè¿”å›ã€‚MySQL åˆ‡æ¢è¯­æ³•å¯ä»¥ä½¿ç”¨ `set SESSION sql_mode = 'ansi'/ 'traditional'`

å¯¹äºåœ¨èšåˆè¯­å¥ä¸­å‡ºç°çš„æœªç”¨èšåˆè¯­å¥åŒ…å›´çš„å­—æ®µå¿…é¡»åœ¨ group by ä¸­å‡ºç°ã€‚

å¯¹äºèšåˆå­—æ®µä¸èƒ½ä½¿ç”¨ where è¯­å¥è¿›è¡Œè¿‡æ»¤ï¼Œå› ä¸º where è¯­å¥æ˜¯åœ¨èšåˆæ“ä½œä¹‹å‰æ‰§è¡Œçš„ï¼Œå› æ­¤åº”è¯¥ä½¿ç”¨ `having` å­å¥è¿›è¡Œæ‰§è¡Œã€‚

```sql
SELECT AVG(s.gpa) as avg_gpa, e.cid FROM enrolled AS e, student AS s 
	WHERE e.sid = s.sid
	HAVING avg_gpa > 3.9;
```

### 2. å­—ç¬¦ä¸²æ“ä½œ

![image-20221021152529512](15445.assets/image-20221021152529512.png)

åœ¨ MySQL ä¸­å­—ç¬¦ä¸²æ˜¯ä¸åˆ†å¤§å°å†™çš„ï¼Œ

æ¯”å¦‚ä¸€ä¸ªå­—æ®µä¸­name = 'jack':

```sql
select * from t where name = 'JACK';
select * from t where name = 'jack';
```

è¿™ä¸¤ç§éƒ½æ˜¯å¯ä»¥æŸ¥åˆ°çš„ã€‚

å¹¶ä¸”ç”¨å­—ç¬¦ä¸²æ ‡è¯†ç”¨å•åŒå¼•å·éƒ½å¯ä»¥è¿›è¡Œæ ‡è¯†ã€‚ä¸ºäº†æ ‡å‡†ä½¿ç”¨ä»¥åæœ€å¥½ä½¿ç”¨å•å¼•å·è¿›è¡Œä½¿ç”¨ã€‚

å­—ç¬¦ä¸²åŒ¹é…ï¼š`%` å¯ä»¥ä»£è¡¨ä»»ä½•ä¸€ä¸ªæˆ–è€…å¤šä¸ªå­—ç¬¦ï¼Œ`_` æ ‡è¯†å•ä¸ªå­—ç¬¦ä¸²

å…¶ä»– string å¤„ç†å‡½æ•°ï¼Œ`SUBSTRING(s, start, length)` , `UPPER`, `LOWER`

å­—ç¬¦ä¸²æ‹¼æ¥ï¼š

* MySQL: `CONCAT()`

### 3. æ—¥æœŸæ“ä½œ

æŸ¥çœ‹å½“å‰æ—¶é—´ï¼š

```sql
# psql
SELECT NOW();
SELECT CURRENT_TIMESTAMP();
# mysql
SELECT NOW();
SELECT CURRENT_TIMESTAMP();
# sqlite
SELECT CURRENT_TIMESTAMP;
```

å°†å­—ç¬¦ä¸²è½¬ä¸ºæ—¥æœŸï¼Œè®¡ç®—å¤©æ•°ï¼š

```sql
# psql
select EXTRACT(DAY from DATE('2020-10-08'));
select DATE('2020-10-01') - DATE('2020-01-01') as days;
# mysql
select EXTRACT(DAY from DATE('2020-10-08'));
select DATEDIFF(DATE('2020-10-01'),  DATE('2020-01-01')) as days;
# sqlite
# first no
select CAST((julianday('2020-10-01') - julianday('2018-01-01')) as INT) as days;
```

### 4. è¾“å‡ºæ§åˆ¶

å³å°†æŸ¥è¯¢çš„ç»“æœè¾“å‡ºåˆ°å¦ä¸€ä¸ªè¡¨ä¸­ï¼š

```sql
# æ–¹å¼ 1
create table demo (
    select id, name, cover from t_web_musics
);
```

è¿™ç§æ–¹å¼ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„è¡¨ï¼Œä½†æ˜¯ä¸ä¼šå¤åˆ¶åŸè¡¨ä¸­çš„ç»“æ„ï¼ˆæ¯”å¦‚å®Œæ•´æ€§çº¦æŸç­‰ï¼‰

```sql
# æ–¹å¼2
insert into demo 
	select id, name, cover from t_web_musics;
```

ç¬¬äºŒç§æ–¹å¼æ˜¯ä½¿ç”¨æ’å…¥çš„æ–¹å¼ï¼Œselect çš„æ•°æ®å†…å®¹å¿…é¡»å’Œæ’å…¥è¡¨ä¸­çš„æ•°æ®ç»“æ„å®Œå…¨ä¸€è‡´ï¼Œå¦åˆ™æ— æ³•å†™å…¥ã€‚

è¾“å‡ºçš„æ—¶å€™ä¹Ÿå¯ä»¥è¿›è¡Œæ’åº `order by`

```sql
select sid, score from t order sid asc, score desc;
```

ä¹Ÿå¯ä»¥æ§åˆ¶è¾“å‡ºçš„è¡Œæ•°ï¼š`limit <count>, offset`

```sql
select * from t limit 10;
select * from t limit 20, 5;
```

### 5. åµŒå¥—æŸ¥è¯¢

åµŒå¥—æŸ¥è¯¢å³ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ä¸­è¿˜åŒ…å«ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ï¼š

```sql
select * from t where col in 
	(select col from t2);
```

é€šå¸¸æƒ…å†µä¸‹æ¯”è¾ƒéš¾å»ä¼˜åŒ–ï¼Œé€šå¸¸ä½¿ç”¨ join æ¥è¿›è¡Œä¼˜åŒ–ã€‚

è¿™ç§æ–¹å¼æ‰§è¡Œæ¯”è¾ƒæ„šè ¢ï¼Œå› ä¸ºé¦–å…ˆéœ€è¦é€šè¿‡å¤–éƒ¨æŸ¥è¯¢æ¥æ‰¾å‡ºæ¯ä¸€ä¸ª tupleï¼Œç„¶ååˆå¾—ä¸€æ¬¡ä¸€æ¬¡æ‰§è¡Œå†…éƒ¨æŸ¥è¯¢ï¼Œå› ä¸ºæ¯æ¬¡æ¯”è¾ƒçš„æ—¶å€™å†…éƒ¨è¿˜éœ€è¦é‡æ–°æŸ¥è¯¢ä¸€éã€‚

å› æ­¤å¯ä»¥ä½¿ç”¨æ›¿ä»£çš„å‡½æ•°ï¼š

* `ALL`ï¼šå¯¹äºå­æŸ¥è¯¢æ‰€æœ‰è¡Œï¼Œå¿…é¡»æ»¡è¶³æ‰€æœ‰æ¡ä»¶
* `ANY` (ç›¸å½“äº `IN`)ï¼šå¯¹äºå­æŸ¥è¯¢ï¼Œåªè¦æœ‰ä¸€è¡Œæ»¡è¶³æ¡ä»¶å³å¯ã€‚
* `EXISTS`ï¼šè‡³å°‘æœ‰ä¸€è¡Œè¿”å›äº†ã€‚

ä¸Šè¿°åµŒå¥—å¾ªç¯å¯ä»¥æ”¹å†™ä¸ºï¼š

```sql
select * from t where col =	ANY(select col from t2);
```

### 6. çª—å£å‡½æ•°

å¸¸è§çª—å£å‡½æ•°ï¼š`rank`, `row_number`, `dense_rank`

çª—å£å‡½æ•°(window function)å¯ä»¥å¯¹æ•°æ®è¿›è¡Œå®æ—¶åˆ†æå¤„ç†ï¼Œå¯ä»¥å¯¹ä¸€ä¸ªé›†åˆè¿›è¡Œå‡½æ•°è®¡ç®—ï¼Œå¹¶ä¸”å°†å…¶èšåˆä¸ºä¸€ä¸ªç»“æœã€‚åƒæ˜¯ä¸€ä¸ªèšåˆå‡½æ•°ï¼Œä½†æ˜¯æ•°æ®é›†åˆä¸ä¼šè¢«åˆ†ç»„åˆ°å•ç‹¬çš„ä¸€ä¸ªç»„ä¸­ã€‚

åŸºç¡€è¯­æ³•ï¼š

```sql
select ... FUNC(...) OVER(...) from t;
```

`FUNC` æ˜¯ç”¨äºèšåˆçš„å‡½æ•°ï¼Œ`OVER` é€‚ç”¨äºåˆ‡åˆ†æ•°æ®çš„å‡½æ•°ï¼Œä¹Ÿå¯ä»¥ç”¨äºæ’åºã€‚

æ¯”å¦‚ä¸ºæ¯ä¸€ä¸ªè®°å½•ç”Ÿæˆè¡Œå·ï¼š

```sql
select ROW_NUMBER() over (), name from t_web_musics;
```

![image-20221021165638087](15445.assets/image-20221021165638087.png)

Over å‡½æ•° Partition by å¯ä»¥å°†è®°å½•è¿›è¡Œåˆ†ç»„ï¼Œç„¶ååœ¨ç»„å†…è¿›è¡Œçª—å£å‡½æ•°æ‰§è¡Œã€‚

![image-20221021170740444](15445.assets/image-20221021170740444.png)

OVER å‡½æ•°è¿˜æ”¯æŒ order by æ“ä½œï¼Œå³åœ¨ç»„å†…è¿›è¡Œæ’åºæ“ä½œï¼Œæ’å®Œåºåæ‰§è¡Œçª—å£å‡½æ•°ã€‚

æ¯”å¦‚ï¼šæ‰¾å‡ºæ¯é—¨è¯¾ä¸­æˆç»©æœ€é«˜çš„å­¦ç”Ÿ

```sql
SELECT * FROM (
	SELECT *, 
		RANK() OVER (PARTITION BY cid ORDER BY grade ASC) AS rank
	FROM enrolled) AS ranking
WHERE ranking.rank = 1
```

psqlã€MySQL 8 ä»¥åŠæœ€æ–°çš„ sqllite éƒ½æ”¯æŒçª—å£å‡½æ•°ã€‚

rank å‡½æ•°åªä¼šå¯¹æ’åºçš„å­—æ®µå¤„ç†ï¼Œå¦‚æœç›¸åŒåˆ™ä¼šå¾—åˆ°ç›¸åŒçš„å€¼ï¼Œå¦‚æœä¸ä½¿ç”¨ order by å‡½æ•°æ‰€æœ‰å€¼éƒ½ä¼šä¸º 1ã€‚

### 7. å…¬ç”¨è¡¨è¡¨è¾¾å¼

å…±ç”¨è¡¨è¡¨è¾¾å¼(Common Table Expression, CTE)ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªè¾…åŠ©è¯­å¥æ¥æ›¿ä»£é•¿è¯­å¥ï¼Œå³ä½¿ç”¨ `with` è¯­å¥ï¼Œå…¶ä¼šåœ¨æ‰§è¡Œæ­£å¸¸ç¨‹åºä¹‹å‰å…ˆè¡Œä¸€æ­¥æ‰§è¡Œã€‚è¿™å¯¹äºå¤§æ‰¹é‡çš„ SQL æ•°æ®ï¼Œå¯ä»¥ä¼˜åŒ–æ€§èƒ½ã€‚

![image-20221021173350149](15445.assets/image-20221021173350149.png)

è¿™å’ŒåµŒå¥—æŸ¥è¯¢æœ‰ä»€ä¹ˆåŒºåˆ«ï¼ŸCTE å¯ä»¥åµŒå¥—æ‰§è¡Œã€‚

![image-20221021174136515](15445.assets/image-20221021174136515.png)

åµŒå¥— CTE æ¯”è¾ƒéš¾ç†è§£ï¼Œä½†æ˜¯ CTE è¿˜æ˜¯æœ‰å¾ˆå¤šäººç”¨çš„ã€‚

## Appendix-0 Pre

### 1. å®‰è£… sqlite

é¦–å…ˆåœ¨[sqliteå®˜ç½‘](https://www.sqlite.org/download.html)ä¸‹è½½ sqlite-autoconf-*.tar.gz æ–‡ä»¶ï¼š

```sh
wget https://www.sqlite.org/2022/sqlite-autoconf-3390400.tar.gz
```

ç„¶åè§£å‹ç¼©ï¼š

```sh
tar -zxvf sqlite-autoconf-3390400.tar.gz
cd sqlite-autoconf-3071502
```

é…ç½®å®‰è£…è·¯å¾„å’Œç¼–è¯‘ï¼š

```sh
./configure --prefix=/usr/local
make && make install
```

æ£€æµ‹æ˜¯å¦å®‰è£…ï¼š

```sh
$ sqlite3
SQLite version 3.39.4 2022-09-29 15:55:41
Enter ".help" for usage hints.
Connected to a transient in-memory database.
Use ".open FILENAME" to reopen on a persistent database.
sqlite>
```

### 2. gradescope

å®éªŒç»“æœè¯„åˆ†éœ€è¦åœ¨ [Gradescope](https://www.gradescope.com/) ç½‘ç«™ä¸Šè¿›è¡Œæäº¤ï¼Œæ³¨å†Œæ‰€éœ€è¦çš„è¯¾ç¨‹ç ä¸€èˆ¬ä¼šåœ¨ [FAQ](https://15445.courses.cs.cmu.edu/fall2021/faq.html) ç½‘é¡µä¸­ç»™å‡ºï¼Œå½“å¹´çš„é CMU å­¦ç”Ÿçš„å®éªŒå¼€æ”¾æ—¶é—´åœ¨å½“å­¦æœŸä¹‹åã€‚

![image-20221024152226735](15445.assets/image-20221024152226735.png)

æ³¨å†Œæ—¶å€™å­¦æ ¡å¡«å†™ Carnegie Mellon University å³å¯ã€‚

## Appendix-1. Homework

2021 homework: https://15445.courses.cs.cmu.edu/fall2021/assignments.html

2022 homework: https://15445.courses.cs.cmu.edu/fall2022/assignments.html

å¯¹åº”é¡µé¢æœ‰å‚è€ƒç­”æ¡ˆã€‚

### 1. SQL

ç›®çš„ï¼šå­¦ä¹  SQL è¯­æ³•å’Œç†Ÿæ‚‰ sqliteã€‚(éœ€è¦å®‰è£…sqlite)

é¦–å…ˆä¸‹è½½å’Œè§£å‹ç¼©æ•°æ®åº“æ–‡ä»¶ï¼š

```sh
wget https://15445.courses.cs.cmu.edu/fall2022/files/imdb-cmudb2022.db.gz
gunzip imdb-cmudb2022.db.gz
```

æŸ¥çœ‹æ•°æ®åº“æ–‡ä»¶ï¼š

```sh
$ sqlite3 imdb-cmudb2022.db
SQLite version 3.39.4 2022-09-29 15:55:41
Enter ".help" for usage hints.
sqlite> .table
akas      crew      episodes  people    ratings   titles
```

ä¸ºå„ä¸ªè¡¨åˆ›å»ºç´¢å¼•ï¼š

```sql
CREATE INDEX ix_people_name ON people (name);
CREATE INDEX ix_titles_type ON titles (type);
CREATE INDEX ix_titles_primary_title ON titles (primary_title);
CREATE INDEX ix_titles_original_title ON titles (original_title);
CREATE INDEX ix_akas_title_id ON akas (title_id);
CREATE INDEX ix_akas_title ON akas (title);
CREATE INDEX ix_crew_title_id ON crew (title_id);
CREATE INDEX ix_crew_person_id ON crew (person_id);
```

æŸ¥çœ‹è¡¨çš„ä¿¡æ¯ï¼š

```sqlite
> .schema people
CREATE TABLE people (
  person_id VARCHAR PRIMARY KEY,
  name VARCHAR,
  born INTEGER,
  died INTEGER
);
CREATE INDEX ix_people_name ON people (name);
```

ğŸ”µQ1: æµ‹è¯•

```sql
SELECT DISTINCT(language) from akas order by language limit 10;
```

ğŸ”µQ2: Find the 10 `Sci-Fi` works with the longest runtimes.

æ¯”è¾ƒç®€å•ï¼š

```sql
SELECT 
	primary_title, premiered, CAST(runtime_minutes AS VARCHAR) || " (mins)" 
FROM titles 
WHERE genres LIKE '%Sci-Fi%'
ORDER BY runtime_minutes DESC
LIMIT 10;
```

ğŸ”µQ3: Determine the oldest people in the dataset who were born in or after 1900. You should assume that a person without a known death year is still alive.

æˆ‘çš„ç­”æ¡ˆï¼š

```sql
SELECT name, age FROM (
    SELECT name, died-born AS age 
    FROM people 
    WHERE born >= 1900 AND died is not NULL 
    UNION 
    SELECT name, 2022-born AS age 
    FROM people
    WHERE born >= 1900 AND died IS NULL
)
ORDER BY age DESC, name ASC
LIMIT 20;
```

ç”±äºä¸ä¼šä½¿ç”¨ if-else è¯­å¥ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´å¯¹æ•´ä¸ªè¡¨æ‰«æäº†ä¸¤éï¼Œæ•ˆç‡æ›´ä½ã€‚

æ ‡å‡†ç­”æ¡ˆï¼š

```sql
SELECT name,
	CASE
		WHEN died IS NOT NULL
		THEN died - born
		ELSE 2022 - born
	END AS age
FROM
	people
WHERE born >= 1900
ORDER BY age DESC, name ASC
LIMIT 20;
```

è¯­æ³•æ ¼å¼ï¼š

```sql
CASE
	WHEN [cond]
	THEN ...
	ELSE ...
END as ..
```

ğŸ”µQ4: Find the people who appear most frequently as crew members.

æˆ‘çš„ç­”æ¡ˆï¼š

```sql
SELECT 
	(SELECT name FROM people p WHERE p.person_id = c.person_id) AS name,
	COUNT(1) AS cnt 
FROM crew c 
GROUP BY c.person_id 
ORDER BY cnt DESC 
LIMIT 20;
```

å‚è€ƒç­”æ¡ˆï¼š

```sql
SELECT
        name, COUNT(*) as num_appearances
FROM
        people
INNER JOIN
        crew ON people.person_id = crew.person_id
GROUP BY name
ORDER BY num_appearances DESC
LIMIT 20;
```

æˆ‘è§‰çš„è¿™ä¸ªå‚è€ƒç­”æ¡ˆæ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸º name å­—æ®µä¸æ˜¯å”¯ä¸€å±æ€§ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šé‡å¤ï¼Œå› æ­¤ç»“æœä¸ä¸€å®šå‡†ç¡®ã€‚

ğŸ”µQ5: Compute intersting statistics on the ratings of content on a per-decade basis.

æˆ‘çš„ç­”æ¡ˆï¼š

```sql
SELECT 
	SUBSTRING(premiered, 1, 3) || "0s" AS decade, 
	ROUND(AVG(r.rating),2) ar, 
	MAX(r.rating), 
	MIN(r.rating), 
	COUNT(1) 
FROM titles t JOIN ratings r ON t.title_id=r.title_id 
WHERE premiered IS NOT NULL 
GROUP BY decade 
ORDER BY ar DESC, decade ASC
LIMIT 20;
```

å‚è€ƒç­”æ¡ˆå¤§è‡´ä¸€è‡´ã€‚

ğŸ”µQ6: Determine the most popular works with a person who has "Cruise" in their name and is born in 1962.

æˆ‘çš„ç­”æ¡ˆï¼š

```sql
SELECT primary_title, votes 
FROM titles t 
JOIN ratings r 
    ON r.title_id=t.title_id 
WHERE r.title_id in (
    SELECT title_id 
    FROM crew c
    JOIN people p 
    	ON c.person_id=p.person_id 
    WHERE name LIKE '%Cruise%' and born = 1962) 
ORDER BY votes DESC 
LIMIT 10;
```

Sqlite ä¸­æ²¡æœ‰ any å‡½æ•°ï¼Œæ”¹ç”¨ in æ‰€ä»¥æ‰§è¡Œæ•ˆç‡ä¼šæœ‰æ‰€é™ä½ã€‚å› æ­¤æ”¹ç”¨ CTE ï¼š

```sql
WITH cruise_title AS (
    SELECT title_id 
    FROM crew c
    JOIN people p 
    	ON c.person_id=p.person_id 
    WHERE name LIKE '%Cruise%' and born = 1962
)

SELECT primary_title, votes 
FROM titles t 
JOIN ratings r 
    ON r.title_id=t.title_id 
WHERE r.title_id in cruise_title
ORDER BY votes DESC 
LIMIT 10;
```

å‚è€ƒç­”æ¡ˆï¼š

```sql
WITH cruise_movies AS (
     SELECT
          crew.title_id AS title_id
     FROM crew
     INNER JOIN
          people ON crew.person_id = people.person_id
     WHERE people.name LIKE "%Cruise%" AND people.born = 1962
)
SELECT
     titles.primary_title as name,
     ratings.votes as votes
FROM
     cruise_movies
INNER JOIN
     ratings ON cruise_movies.title_id = ratings.title_id
INNER JOIN
     titles ON cruise_movies.title_id = titles.title_id
ORDER BY votes DESC
LIMIT 10;
```

ğŸ”µQ7: List the number of works that premiered in the same year that "Army of Thieves" premiered.

æˆ‘çš„ç­”æ¡ˆï¼š

```sql
WITH year AS (
    SELECT premiered 
    FROM titles 
    WHERE primary_title='Army of Thieves'
) 
SELECT COUNT(1) 
FROM titles 
WHERE premiered IN year;
```

å‚è€ƒç­”æ¡ˆå¤§è‡´ä¸€è‡´ã€‚

ğŸ”µQ8: List the all the different actors and actresses who have starred in a work with Nicole Kidman (born in 1967).

æˆ‘çš„ç­”æ¡ˆï¼š

```sql
SELECT 
	DISTINCT name 
FROM people 
JOIN crew 
	ON crew.person_id=people.person_id 
WHERE 
	category IN ('actor', 'actress') 
	AND 
	title_id IN (
        SELECT title_id 
        FROM crew c 
        JOIN people p 
        	ON c.person_id=p.person_id 
        WHERE name='Nicole Kidman') 
ORDER BY name ASC;
```

ğŸ”µQ9: For all people born in 1955, get their name and average rating on all movies they have been part of through their careers. Output the 9th decile of individuals as measured by their average career movie rating.

å­¦ä¼šä½¿ç”¨çª—å£å‡½æ•°ã€‚

æˆ‘çš„ç­”æ¡ˆï¼š

```sql
WITH t AS (
    SELECT
    	name, rating
    FROM people p
    JOIN crew c ON p.person_id=c.person_id
    JOIN titles t ON c.title_id=t.title_id
    JOIN ratings r ON r.title_id=t.title_id
    WHERE born = 1955 AND type='movie'
)
SELECT name, ar
FROM (
    SELECT
        name, ROUND(AVG(rating), 2) ar, NTILE(10) OVER(ORDER BY AVG(rating)) as nt
    FROM t
    GROUP BY name
    ORDER BY ar DESC, name ASC
)
WHERE nt = 9;
```

å‚è€ƒç­”æ¡ˆï¼š

```sql
WITH actors_and_movies_1955 AS (
     SELECT
          people.person_id,
          people.name,
          titles.title_id,
          titles.primary_title
     FROM
          people
     INNER JOIN
          crew ON people.person_id = crew.person_id
     INNER JOIN
          titles ON crew.title_id = titles.title_id
     WHERE people.born = 1955 AND titles.type = "movie"
),
actor_ratings AS (
     SELECT
          name,
          ROUND(AVG(ratings.rating), 2) as rating
     FROM ratings
     INNER JOIN actors_and_movies_1955 ON ratings.title_id = actors_and_movies_1955.title_id
     GROUP BY actors_and_movies_1955.person_id
),
quartiles AS (
     SELECT *, NTILE(10) OVER (ORDER BY rating ASC) AS RatingQuartile FROM actor_ratings
)
SELECT name, rating
FROM quartiles
WHERE RatingQuartile = 9
ORDER BY rating DESC, name ASC;
```

ğŸ”µQ10: Concatenate all the unique titles for the **TV Series** "House of the Dragon" as a string of comma-separated values in alphabetical order of the titles.

ä¸ä¼šé€’å½’ CTEã€‚

å‚è€ƒç­”æ¡ˆï¼š

```sql
with p as (
      select titles.primary_title as name, akas.title as dubbed
      from titles
      inner join akas on titles.title_id = akas.title_id
      where titles.primary_title = "House of the Dragon" AND titles.type = 'tvSeries'
      group by titles.primary_title, akas.title
      order by akas.title
),
c as (
      select row_number() over (order by p.name asc) as seqnum, p.dubbed as dubbed
      from p
),
flattened as (
      select seqnum, dubbed
      from c
      where seqnum = 1
      union all
      select c.seqnum, f.dubbed || ', ' || c.dubbed
      from c join
            flattened f
            on c.seqnum = f.seqnum + 1
)
select dubbed from flattened
order by seqnum desc limit 1;
```

## Appendix-2. Lab